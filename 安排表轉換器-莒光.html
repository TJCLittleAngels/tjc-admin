<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>Google Ë©¶ÁÆóË°® CSV ËΩâÊèõ & Firebase ‰∏äÂÇ≥</title>
    <!-- Papa Parse (CSV Ëß£Êûê) -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <!-- Firebase SDK (ËàäÁ®ãÂºèÁ¢ºÂèÉËÄÉ) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
      :root {
        /* Âõ∫ÂÆö‰ΩøÁî®Ê∑∫Ëâ≤Á≥ª */
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #1e293b;
        --muted: #64748b;
        --primary: #2a5d9f;
        --primary-600: #244f86;
        --danger: #c62828;
        --danger-600: #b71c1c;
        --ring: #93c5fd;
        --radius: 12px;
        --shadow: 0 6px 24px rgba(15, 23, 42, 0.08);
        --space-1: 6px;
        --space-2: 10px;
        --space-3: 14px;
        --space-4: 20px;
        --space-5: 28px;
        --font-sm: 14px;
        --font-md: 16px;
        --font-lg: 18px;
        --font-xl: 22px;

        /* ËÆìÁÄèË¶ΩÂô®ÊéßÂà∂È†ÖÂõ∫ÂÆöËµ∞Ê∑∫Ëâ≤ */
        color-scheme: light;
      }

      html,
      body {
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
      }

      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: var(--space-5) var(--space-4);
      }

      h1 {
        font-size: 28px;
        margin: 0 0 var(--space-4);
        letter-spacing: 0.2px;
        color: var(--text);
      }
      h2,
      h3 {
        margin: var(--space-4) 0 var(--space-3);
        color: var(--text);
      }

      .grid {
        display: grid;
        gap: var(--space-4);
        grid-template-columns: 1fr;
      }
      @media (min-width: 980px) {
        .grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      .card {
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: var(--space-4);
      }

      .section-title {
        margin: 0 0 var(--space-3);
        font-size: var(--font-lg);
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text);
      }

      .form-row {
        margin-bottom: var(--space-3);
      }
      .form-row label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--text);
      }
      .form-row input,
      .form-row select,
      .form-row button {
        font-size: var(--font-md);
      }
      .form-row input,
      .form-row select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        color: var(--text);
        transition: all 0.2s ease;
      }
      .form-row input:focus,
      .form-row select:focus {
        outline: none;
        border-color: var(--ring);
        box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.35);
      }

      .btns {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #c7cdd8;
        background: #e9eef6;
        color: #0f172a;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.35);
      }
      .btn.primary {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary-600);
      }
      .btn.primary:hover {
        background: var(--primary-600);
      }
      .btn.danger {
        background: var(--danger);
        color: #fff;
        border-color: var(--danger-600);
      }
      .btn.danger:hover {
        background: var(--danger-600);
      }

      pre#output {
        background: #0b1221;
        color: #e5e7eb;
        border-radius: 10px;
        padding: var(--space-4);
        font-size: 12px;
        max-height: 360px;
        overflow: auto;
        box-shadow: var(--shadow);
        line-height: 1.5;
      }

      .user-card {
        background: var(--card);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: var(--space-4);
        margin: var(--space-3) 0;
        max-width: none;
      }
      .user-card h4 {
        color: var(--primary);
        letter-spacing: 0.4px;
        margin: 0 0 12px 0;
      }
      .user-job-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .user-job-list li {
        padding: 8px 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        font-size: var(--font-sm);
      }
      .user-job-list li:last-child {
        border-bottom: none;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.15s ease-out both;
      }
      .modal {
        width: min(520px, 92vw);
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        font-size: 14px;
        transform: translateY(8px);
        animation: slideIn 0.18s ease-out both;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .modal header {
        padding: 12px 16px;
        background: var(--primary);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .modal header h4 {
        margin: 0;
        font-size: 16px;
        letter-spacing: 0.5px;
      }
      .modal header button {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
      }
      .modal header button:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .modal .content {
        padding: 16px;
      }
      .modal .row {
        margin: 10px 0;
      }
      .modal .row label {
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
        color: var(--text);
      }
      .modal .row select,
      .modal .row input {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background: #ffffff;
        color: var(--text);
      }
      .modal .actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        padding: 12px 16px;
        background: rgba(148, 163, 184, 0.12);
      }
      .modal .actions button {
        padding: 8px 14px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 6px;
        border: 1px solid #ddd;
        transition: all 0.2s ease;
      }
      .modal .actions .danger {
        background: var(--danger);
        color: #fff;
        border-color: var(--danger-600);
      }
      .modal .actions .danger:hover {
        background: var(--danger-600);
      }
      .modal .hint {
        color: var(--muted);
        font-size: 12px;
        margin-top: 6px;
        line-height: 1.4;
      }
      .modal .warn {
        color: var(--danger);
        font-weight: 600;
      }

      .hr {
        height: 1px;
        background: rgba(148, 163, 184, 0.35);
        margin: var(--space-4) 0;
        border: none;
      }

      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--card);
        color: var(--text);
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        max-width: 300px;
      }
      .toast.show {
        transform: translateX(0);
      }
      .toast.success {
        border-left: 4px solid #10b981;
      }
      .toast.error {
        border-left: 4px solid var(--danger);
      }
      .toast.info {
        border-left: 4px solid var(--primary);
      }

      #imagePreviewContainer {
        border: 1px solid rgba(148, 163, 184, 0.3);
        padding: 12px;
        border-radius: 8px;
        background: rgba(148, 163, 184, 0.05);
        text-align: center;
      }
      #imagePreviewContainer img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 6px;
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Google Ë©¶ÁÆóË°® CSV ËΩâÊèõ & Firebase ‰∏äÂÇ≥</h1>

      <div class="grid">
        <!-- Â∑¶ÔºöGoogle Sheet Ëß£Êûê -->
        <div class="card">
          <h3 class="section-title">üìä Google Ë©¶ÁÆóË°®Ëß£Êûê</h3>
          <div class="form-row">
            <label for="urlInput">(ËéíÂÖâÊïôÊúÉ)Ë©¶ÁÆóË°®Á∂≤ÂùÄ / Sheet ID</label>
            <input
              type="text"
              id="urlInput"
              placeholder="Ë≤º‰∏ä Google Ë©¶ÁÆóË°®Á∂≤ÂùÄÊàñËº∏ÂÖ• Sheet ID"
              value="https://docs.google.com/spreadsheets/d/1MiJOg52vv4ydrZpx6QxhfYy96Fy0uCZs/edit?gid=1775042568#gid=1775042568"
            />
          </div>
          <div class="btns">
            <button id="parseButton" class="btn">Ëß£ÊûêÁ∂≤ÂùÄ</button>
          </div>
          <div class="form-row">
            <label for="sheetIdInput">Sheet ID</label>
            <input type="text" id="sheetIdInput" placeholder="sheetId" />
          </div>
          <div class="form-row">
            <label for="gidInput">gid</label>
            <input type="text" id="gidInput" placeholder="gid" />
          </div>
          <div class="btns">
            <button id="fetchButton" class="btn primary">ÊäìÂèñË≥áÊñô‰∏¶Ëß£Êûê</button>
            <button id="openJsonModalBtn" class="btn">Êü•ÁúãËß£Êûê JSON</button>
          </div>
        </div>

        <!-- Âè≥ÔºöÂúñÁâáÁ∂≤ÂùÄ‰∏äÂÇ≥ -->
        <div class="card">
          <h3 class="section-title">üñºÔ∏è ‰∏äÂÇ≥ÂúñÁâáÁ∂≤ÂùÄËá≥ Firebase</h3>
          <div class="form-row">
            <label for="imageUrlInput">ÂúñÁâáÁ∂≤ÂùÄ</label>
            <input
              type="url"
              id="imageUrlInput"
              placeholder="https://example.com/image.jpg"
            />
          </div>
          <div class="btns">
            <button id="previewImageBtn" class="btn">Ê™¢Ë¶ñÂúñÁâá</button>
          </div>

          <!-- ÂúñÁâáÈ†êË¶ΩÂçÄÂüü -->
          <div id="imagePreviewContainer" style="display: none">
            <img id="previewImage" />
            <div style="margin-top: 8px; font-size: 0.9em; color: var(--muted)">
              ÂúñÁâáÈ†êË¶Ω
            </div>
          </div>

          <div class="form-row">
            <label for="uploadTypeSelect">‰∏äÂÇ≥È°ûÂûã</label>
            <select id="uploadTypeSelect">
              <option value="schedule">ÂÆâÊéíË°®</option>
              <option value="‰∏≠Á¥öÁè≠">‰∏≠Á¥öÁè≠</option>
              <option value="‰ø°‰ª∞ÈÄ†Â∞±Áè≠">‰ø°‰ª∞ÈÄ†Â∞±Áè≠</option>
              <option value="ÂàùÁ¥öÁè≠">ÂàùÁ¥öÁè≠</option>
              <option value="Â∞ëÂπ¥Áè≠">Â∞ëÂπ¥Áè≠</option>
              <option value="ÂπºÂÖíÁè≠">ÂπºÂÖíÁè≠</option>
              <option value="ÂπºÂπ¥Áè≠">ÂπºÂπ¥Áè≠</option>
            </select>
          </div>

          <div id="monthSelectContainer" class="form-row">
            <label for="imageMonthSelect">ÈÅ∏ÊìáÂπ¥Êúà</label>
            <select id="imageMonthSelect">
              <!-- ÂãïÊÖãÁîüÊàêÈÅ∏È†Ö -->
            </select>
          </div>

          <div class="btns">
            <button id="uploadImageBtn" class="btn primary">
              ‰∏äÂÇ≥ÂúñÁâáÁ∂≤ÂùÄËá≥ Firebase
            </button>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- ‰∏äÂÇ≥Â∑•‰ΩúË°® -->
      <div class="card">
        <h3 class="section-title">üì§ ‰∏äÂÇ≥Â∑•‰ΩúË°®Ëá≥ Firebase</h3>
        <div class="form-row">
          <label for="monthInput">Êúà‰ªΩ (Ê†ºÂºèÔºöyyyymm)</label>
          <input type="text" id="monthInput" placeholder="202503" />
        </div>
        <div class="btns">
          <button id="uploadBtn" class="btn primary">
            ‰∏äÂÇ≥Â∑•‰ΩúË°®Ëá≥ Firebase
          </button>
          <button id="openDeleteMenuBtn" class="btn danger">
            ÈñãÂïüÂà™Èô§ÂäüËÉΩÈÅ∏ÂñÆ
          </button>
        </div>
      </div>

      <div class="grid">
        <!-- ÂéüÊú¨ JSON Âç°ÁâáÁöÑ‰ΩçÁΩÆ ‚Üí ÊèõÊàê„Äå‰ΩøÁî®ËÄÖÂ∑•‰ΩúÊÉÖÂΩ¢„Äç -->
        <div class="card">
          <h3 class="section-title">üë• ‰ΩøÁî®ËÄÖÂ∑•‰ΩúÊÉÖÂΩ¢</h3>

          <!-- ÁØ©ÈÅ∏Âô® -->
          <div class="form-row">
            <label for="jobFilterSelect">‰æùÂ∑•‰ΩúÈ†ÖÁõÆÁØ©ÈÅ∏</label>
            <select id="jobFilterSelect" disabled>
              <option value="ALL">ÔºàÂÖ®ÈÉ®Â∑•‰ΩúÔºâ</option>
            </select>
          </div>

          <div id="userJobs">
            <div style="text-align: center; color: var(--muted); padding: 20px">
              Â∞öÊú™Áî¢ÁîüÂ∑•‰ΩúÊ∏ÖÂñÆ
            </div>
          </div>
        </div>

        <!-- ÂéüÊú¨„Äå‰ΩøÁî®ËÄÖÂ∑•‰ΩúÊÉÖÂΩ¢„ÄçÁöÑ‰ΩçÁΩÆ ‚Üí ÊèõÊàê„ÄåÂ∑≤Âà™Èô§Â∑•‰ΩúÂçÄÂüü„Äç -->
        <div class="card">
          <h3 class="section-title">üóëÔ∏è Â∑≤Âà™Èô§Â∑•‰ΩúÂçÄÂüüÔºàÂèØÂæ©ÂéüÔºâ</h3>
          <div id="deletedJobs">
            <div style="text-align: center; color: var(--muted); padding: 20px">
              Â∞öÁÑ°Â∑≤Âà™Èô§ÁöÑÂ∑•‰Ωú
            </div>
          </div>
        </div>
      </div>

      <!-- Toast Ë®äÊÅØÁ≥ªÁµ± -->
      <div id="toast" class="toast" aria-live="polite"></div>
    </div>
    <!-- /.container ÁµêÊùü -->

    <!-- JSON ÂÖßÂÆπÊ™¢Ë¶ñ Modal -->
    <div id="jsonModalBackdrop" class="modal-backdrop" aria-hidden="true">
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="jsonModalTitle"
      >
        <header>
          <h4 id="jsonModalTitle">Ëß£ÊûêÂæåÁöÑË°®Ê†º (JSON)</h4>
          <button id="jsonModalCloseBtn" title="ÈóúÈñâ">‚úï</button>
        </header>
        <div class="content">
          <pre
            id="jsonOutput"
            style="
              background: #0b1221;
              color: #e5e7eb;
              border-radius: 10px;
              padding: 16px;
              font-size: 12px;
              max-height: 60vh;
              overflow: auto;
              margin: 0;
            "
          >
Â∞öÊú™Ëß£Êûê...</pre
          >
        </div>
        <div class="actions">
          <button id="jsonModalCloseBtn2">ÈóúÈñâ</button>
        </div>
      </div>
    </div>

    <!-- Delete Menu Modal -->
    <div id="deleteModalBackdrop" class="modal-backdrop" aria-hidden="true">
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="deleteModalTitle"
      >
        <header>
          <h4 id="deleteModalTitle">Âà™Èô§ÂäüËÉΩÈÅ∏ÂñÆ</h4>
          <button id="deleteModalCloseBtn" title="ÈóúÈñâ">‚úï</button>
        </header>
        <div class="content">
          <div class="row">
            <label for="deleteModeSelect">ÈÅ∏ÊìáÂà™Èô§È°ûÂûã</label>
            <select id="deleteModeSelect">
              <option value="scheduleData">Âà™Èô§„ÄåÂÆâÊéíË°®Ë≥áÊñô„ÄçÔºàÈúÄÂπ¥ÊúàÔºâ</option>
              <option value="scheduleImage">
                Âà™Èô§„ÄåÂÆâÊéíË°®ÂúñÁâá„ÄçÔºàÈúÄÂπ¥ÊúàÔºâ
              </option>
              <option value="classImage">Âà™Èô§„ÄåÁè≠Á¥öÂúñÁâá„ÄçÔºàÈÅ∏Áè≠Á¥öÔºâ</option>
            </select>
            <div class="hint">
              <div><strong>Ë≥áÊñôË∑ØÂæëÂ∞çÁÖßÔºö</strong></div>
              <div>ÂÆâÊéíË°®Ë≥áÊñôÔºö<code>line/schedule/jgtjc/{yyyymm}</code></div>
              <div>
                ÂÆâÊéíË°®ÂúñÁâáÔºö<code
                  >line/schedule/jgtjc/schedule_image/{yyyymm}</code
                >
              </div>
              <div>
                Áè≠Á¥öÂúñÁâáÔºö<code>line/schedule/jgtjc/class/{Áè≠Á¥öÂêç}</code>
              </div>
            </div>
          </div>

          <div class="row" id="deleteMonthRow">
            <label for="deleteMonthInput2">ÊåáÂÆöÊúà‰ªΩ (yyyymm)</label>
            <input type="text" id="deleteMonthInput2" placeholder="202503" />
          </div>

          <div class="row" id="deleteClassRow" style="display: none">
            <label for="deleteClassSelect">ÈÅ∏ÊìáÁè≠Á¥ö</label>
            <select id="deleteClassSelect">
              <!-- ‰æù‰Ω†‰∏äÂÇ≥ÊôÇ‰ΩøÁî®ÁöÑÁè≠Á¥öÈÅ∏È†ÖÂêåÊ≠• -->
              <option value="‰∏≠Á¥öÁè≠">‰∏≠Á¥öÁè≠</option>
              <option value="‰ø°‰ª∞ÈÄ†Â∞±Áè≠">‰ø°‰ª∞ÈÄ†Â∞±Áè≠</option>
              <option value="ÂàùÁ¥öÁè≠">ÂàùÁ¥öÁè≠</option>
              <option value="Â∞ëÂπ¥Áè≠">Â∞ëÂπ¥Áè≠</option>
              <option value="ÂπºÂÖíÁè≠">ÂπºÂÖíÁè≠</option>
              <option value="ÂπºÂπ¥Áè≠">ÂπºÂπ¥Áè≠</option>
            </select>
            <div class="hint">
              Ê≠§Êìç‰ΩúÊúÉÂà™Èô§Ë©≤Áè≠Á¥öÁõÆÂâçÂÑ≤Â≠òÂú®Ë≥áÊñôÂ∫´ÁöÑÂúñÁâáÁ∂≤ÂùÄ„ÄÇ
            </div>
          </div>

          <div class="hint warn">‚ö†Ô∏è Âà™Èô§ÁÇ∫‰∏çÂèØÈÄÜÊìç‰ΩúÔºåË´ãÂÜçÊ¨°Á¢∫Ë™çÔºÅ</div>
        </div>
        <div class="actions">
          <button id="deleteModalCancelBtn">ÂèñÊ∂à</button>
          <button id="doDeleteBtn" class="danger">Âà™Èô§</button>
        </div>
      </div>
    </div>

    <script>
      /*******************************************************
       * 1. Firebase ÂàùÂßãÂåñ (Ë´ãÊèõÊàê‰Ω†Ëá™Â∑±ÁöÑ Firebase config)
       *******************************************************/
      const firebaseConfig = {
        apiKey: "AIzaSyCGAdNce7wCJLPmqPZ4ID3PxvBDFDD8uSY",
        authDomain: "tjc-tw.firebaseapp.com",
        databaseURL:
          "https://tjc-tw-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tjc-tw",
        storageBucket: "tjc-tw.firebasestorage.app",
        messagingSenderId: "857954351277",
        appId: "1:857954351277:web:448c392836ef137e44ee24",
        measurementId: "G-Y3T47ZWQCB",
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      /*******************************************************
       * 2. Ëß£Êûê Google Ë©¶ÁÆóË°®Á∂≤ÂùÄÔºåÂèñÂæó sheetId Ëàá gid
       *******************************************************/
      function parseSpreadsheetUrl(url) {
        let sheetId = "";
        let gid = "";
        const idMatch = url.match(/\/d\/([^/]+)/);
        if (idMatch && idMatch[1]) {
          sheetId = idMatch[1];
        }
        const gidMatch = url.match(/gid=([^&]+)/);
        if (gidMatch && gidMatch[1]) {
          gid = gidMatch[1];
        }
        return { sheetId, gid };
      }

      /*******************************************************
       * ËéíÂÖâÊïôÊúÉÁâπÂåñÂáΩÊï∏ÔºöËôïÁêÜÊé•ÂæÖ‰∫∫Âì°ÂíåÁÇä‰∫ãËá™ÂãïË£úÂÖ®
       *******************************************************/
      function jgtjcProcessReceptionist(data) {
        return data.map((row) => {
          return row.map((cell, cellIndex) => {
            if (cellIndex < row.length - 1) {
              const currentCell = cell.trim();
              const nextCell = row[cellIndex + 1].trim();

              // ËôïÁêÜÊé•ÂæÖ‰∫∫Âì°
              if (
                currentCell === "Êé•ÂæÖ‰∫∫Âì°" &&
                (nextCell === "" || nextCell === "-")
              ) {
                row[cellIndex + 1] = "Êé•ÂæÖ‰∫∫Âì°";
              }

              // ËôïÁêÜÁÇä‰∫ã - Ëá™ÂãïÂæÄÂæåÈù¢Ë£úÂÖ©Ê†ºÔºàÂ¶ÇÊûúÊòØÁ©∫ÁöÑÔºâ
              if (currentCell === "ÁÇä‰∫ã") {
                // Ê™¢Êü•ÂæåÈù¢ÂÖ©Ê†ºÊòØÂê¶ÁÇ∫Á©∫
                if (
                  cellIndex + 1 < row.length &&
                  (row[cellIndex + 1].trim() === "" ||
                    row[cellIndex + 1].trim() === "-")
                ) {
                  row[cellIndex + 1] = "ÁÇä‰∫ã";
                }
                if (
                  cellIndex + 2 < row.length &&
                  (row[cellIndex + 2].trim() === "" ||
                    row[cellIndex + 2].trim() === "-")
                ) {
                  row[cellIndex + 2] = "ÁÇä‰∫ã";
                }
              }
            }
            return cell;
          });
        });
      }

      /*******************************************************
       * ËéíÂÖâÊïôÊúÉÁâπÂåñÂáΩÊï∏ÔºöËá™ÂãïÂ°´ÂÖ•Ë•øÂÖÉÂπ¥Êúà‰ªΩ
       *******************************************************/
      function jgtjcAutoFillYearMonth(data) {
        // Â∞ãÊâæÁ¨¨‰∏ÄÂÄãÂåÖÂê´ "XXXÂπ¥XXÊúà" Ê†ºÂºèÁöÑË≥áÊñô
        for (let rowIndex = 0; rowIndex < data.length; rowIndex++) {
          const row = data[rowIndex];
          for (let colIndex = 0; colIndex < row.length; colIndex++) {
            const cell = row[colIndex];
            if (cell && typeof cell === "string") {
              const match = cell.match(/(\d{3,4})Âπ¥(\d{1,2})Êúà/);
              if (match) {
                let year = match[1];
                const month = match[2].padStart(2, "0"); // Á¢∫‰øùÊúà‰ªΩÊòØÂÖ©‰ΩçÊï∏

                // Ê∞ëÂúãÂπ¥ËΩâË•øÂÖÉÂπ¥ÔºàÊ∞ëÂúãÂπ¥ + 1911 = Ë•øÂÖÉÂπ¥Ôºâ
                const westernYear = parseInt(year) + 1911;
                const yearMonth = westernYear.toString() + month;

                // Ëá™ÂãïÂ°´ÂÖ•Âà∞Êúà‰ªΩËº∏ÂÖ•Ê°Ü
                const monthInput = document.getElementById("monthInput");
                if (monthInput) {
                  monthInput.value = yearMonth;
                  console.log(
                    "Ê∞ëÂúãÂπ¥ËΩâË•øÂÖÉÂπ¥Ôºö",
                    match[1] + "Âπ¥" + match[2] + "Êúà ‚Üí " + yearMonth
                  );
                }
                return yearMonth; // ËøîÂõûÊâæÂà∞ÁöÑÂπ¥Êúà
              }
            }
          }
        }
        return null; // Â¶ÇÊûúÊ≤íÊâæÂà∞Â∞±ËøîÂõû null
      }

      /*******************************************************
       * ËéíÂÖâÊïôÊúÉÁâπÂåñÂáΩÊï∏ÔºöËôïÁêÜÊ∏ÖÊéÉÂçÄÂüüÂíåÁí∞Â¢ÉÊ∏ÖÊΩîÁöÑÈóúËÅØ
       *******************************************************/
      function jgtjcProcessCleaningArea(workSheet) {
        // Âª∫Á´ãÊó•ÊúüÂà∞Ê∏ÖÊéÉÂçÄÂüüÁöÑÊò†Â∞Ñ
        const dateToCleaningArea = {};

        // Á¨¨‰∏ÄÈÅçÔºöÊî∂ÈõÜÊâÄÊúâÊ∏ÖÊéÉÂçÄÂüüÁöÑË≥áË®ä
        for (const personName in workSheet) {
          workSheet[personName].forEach((job) => {
            if (job.task === "Ê∏ÖÊéÉÂçÄÂüü") {
              const date = job.date;
              // Êää‰∫∫ÂêçÁï∂‰ΩúÂçÄÂüüË≥áË®ä
              if (!dateToCleaningArea[date]) {
                dateToCleaningArea[date] = [];
              }
              dateToCleaningArea[date].push(personName);
            }
          });
        }

        // Á¨¨‰∫åÈÅçÔºöÊõ¥Êñ∞Áí∞Â¢ÉÊ∏ÖÊΩîÁöÑÂ∑•‰ΩúÂÖßÂÆπ
        for (const personName in workSheet) {
          workSheet[personName].forEach((job) => {
            if (job.task === "Áí∞Â¢ÉÊ∏ÖÊΩî") {
              const date = job.date;
              const areas = dateToCleaningArea[date];
              if (areas && areas.length > 0) {
                // Â∞áÂçÄÂüüË≥áË®äÂêà‰ΩµÂà∞Áí∞Â¢ÉÊ∏ÖÊΩî‰∏≠
                job.task = `Áí∞Â¢ÉÊ∏ÖÊΩî-ÂçÄÂüüÔºö${areas.join("„ÄÅ")}`;
              }
            }
          });
        }

        console.log("ËôïÁêÜÊ∏ÖÊéÉÂçÄÂüüÂæåÁöÑÁµêÊûúÔºö", workSheet);
        return workSheet;
      }

      /*******************************************************
       * JGC ÁâπÂåñÁöÑ‰∫∫ÂêçÂàáÂàÜÂáΩÂºè
       *******************************************************/
      /**
       * JGC ÁâπÂåñÁöÑ‰∫∫ÂêçÂàáÂàÜÔºö
       * - Ëã•Êï¥‰∏≤ÂâõÂ•ΩÊòØ„ÄåÂ≠ó Á©∫Ê†º Â≠ó„ÄçÔºàÂÖ©ÂÄã Han Â≠ó‰∏≠Èñì‰∏ÄÂÄãÁ©∫Ê†ºÔºâÔºåË¶ñÁÇ∫ÂñÆ‰∏Ä‰∫∫ÂêçÔºåÁßªÈô§Á©∫Ê†º„ÄÇ
       * - ÂÖ∂‰ªñÊÉÖÊ≥ÅÔºö‰ª•„Äå‚à£„ÄçÊàñÁ©∫ÁôΩÂàáÂàÜÂ§ö‰Ωç‰∫∫Âêç„ÄÇ
       * - Ëá™ÂãïÂéªÈô§Â§öÈ§òÁ©∫ÁôΩ„ÄÇ
       */
      function splitNamesJGC(cellVal) {
        // Ê®ôÊ∫ñÂåñÁ©∫ÁôΩÔºöÂ§öÁ©∫ÁôΩ -> ÂñÆÁ©∫ÁôΩÔºõÂâçÂæåÂéªÁ©∫ÁôΩ
        let s = cellVal.trim().replace(/\s+/g, " ");

        // Áâπ‰æãÔºö„ÄåÂ≠ó Á©∫Ê†º Â≠ó„Äç=> ÂñÆ‰∏Ä‰∫∫ÂêçÔºàÂÖ©ÂÄãÊº¢Â≠ó‰∏≠Èñì‰∏ÄÂÄãÁ©∫Ê†ºÔºâ
        // ‰ΩøÁî® Unicode Script=Han ÂÅµÊ∏¨‰∏≠ÊñáÊº¢Â≠ó
        const twoHanWithOneSpace = /^[\p{Script=Han}]\s[\p{Script=Han}]$/u;
        if (twoHanWithOneSpace.test(s)) {
          return [s.replace(" ", "")]; // Êää‰∏≠ÈñìÁ©∫Ê†ºÁßªÈô§
        }

        // ‰∏ÄËà¨ÊÉÖÊ≥ÅÔºö‰ª• ‚à£ ÊàñÁ©∫ÁôΩÂàáÂàÜ
        const parts = s
          .split(/[‚à£\s]+/)
          .map((x) => x.trim())
          .filter(Boolean);
        return parts;
      }

      /*******************************************************
       * 3. ‰æùÊ∞¥Âπ≥Á©∫ÁôΩË°å„ÄÅÂûÇÁõ¥Á©∫ÁôΩÊ¨ÑÂàáÂâ≤ CSV
       *******************************************************/
      function splitTablesByEmptyRowsAndColumns(csvData) {
        // 1) Ê∞¥Âπ≥Á©∫ÁôΩË°å
        const blocks = [];
        let currentBlock = [];
        csvData.forEach((row) => {
          const isRowEmpty = row.every((cell) => cell.trim() === "");
          if (isRowEmpty) {
            if (currentBlock.length > 0) {
              blocks.push(currentBlock);
              currentBlock = [];
            }
          } else {
            currentBlock.push(row);
          }
        });
        if (currentBlock.length > 0) {
          blocks.push(currentBlock);
        }

        // 2) ÂûÇÁõ¥Á©∫ÁôΩÊ¨Ñ
        const tables = [];
        blocks.forEach((block) => {
          const maxColumns = block.reduce(
            (max, row) => Math.max(max, row.length),
            0
          );
          let boundary = -1;
          for (let col = 1; col < maxColumns - 1; col++) {
            let emptyCount = 0;
            block.forEach((row) => {
              if (!row[col] || row[col].trim() === "") {
                emptyCount++;
              }
            });
            if (emptyCount > block.length / 1) {
              boundary = col;
              break;
            }
          }
          if (boundary === -1) {
            tables.push(block);
          } else {
            const leftTable = block.map((row) => row.slice(0, boundary));
            const rightTable = block.map((row) => row.slice(boundary));
            tables.push(leftTable, rightTable);
          }
        });

        console.log("ÂàÜÂçÄÂæåÁöÑÁµêÊûúÔºö", tables);
        return tables;
      }

      /*******************************************************
       * 4. ‰æù„ÄåÊó•Êúü/ÊòüÊúü„ÄçÈóúÈçµÂ≠óÈÄ≤‰∏ÄÊ≠•ÂàÜÂâ≤
       *******************************************************/
      function splitTablesByDateKeyword(tableBlocks) {
        const finalSubTables = [];

        function isDateHeader(row) {
          return row.some((cell) => {
            const txt = cell.trim();
            return txt.includes("Êó•Êúü") || txt.includes("ÊòüÊúü");
          });
        }
        function isRowEmpty(row) {
          return row.every((cell) => cell.trim() === "");
        }
        function isValidDateOrWeek(row) {
          if (row.length === 0) return false;
          const text = row[0].trim();
          if (text === "") return true; // Á©∫Â≠ó‰∏≤
          if (!isNaN(text)) return true; // Á¥îÊï∏Â≠ó
          const firstChar = text.charAt(0);
          const validChars = ["‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠", "Êó•"];
          if (validChars.includes(firstChar)) return true;
          if (text === "ÊòüÊúü" || text === "Êó•Êúü") return true;
          const withoutDash = text.replace("-", "");
          if (!isNaN(withoutDash)) return true;
          return false;
        }

        tableBlocks.forEach((block) => {
          if (block.every((row) => row[0].trim() === "")) {
            block.forEach((row) => row.shift());
          }
          let subTables = [];
          let currentSubTable = [];
          let emptyLineCount = 0;
          let inSubTable = false;

          block.forEach((row) => {
            const rowIsEmpty = isRowEmpty(row);
            emptyLineCount = rowIsEmpty ? emptyLineCount + 1 : 0;
            const hasDateHeader = isDateHeader(row);

            if (hasDateHeader) {
              if (inSubTable && currentSubTable.length > 0) {
                subTables.push(currentSubTable);
                currentSubTable = [];
              }
              inSubTable = true;
              currentSubTable.push(row);
            } else if (inSubTable && !rowIsEmpty) {
              currentSubTable.push(row);
            }

            if (emptyLineCount >= 2 && inSubTable) {
              subTables.push(currentSubTable);
              currentSubTable = [];
              inSubTable = false;
            }
            if (!isValidDateOrWeek(row) && inSubTable) {
              currentSubTable.pop();
              subTables.push(currentSubTable);
              currentSubTable = [];
              inSubTable = false;
            }
          });
          if (currentSubTable.length > 0) {
            subTables.push(currentSubTable);
          }
          if (subTables.length === 0) {
            subTables.push(block);
          }
          finalSubTables.push(subTables);
        });

        console.log("‰∫åÊ¨°ÂàáÂâ≤ÁµêÊûúÔºö", finalSubTables);
        return finalSubTables;
      }

      /*******************************************************
       * 5. ÂæûÁ¨¨‰∏ÄÂÄãÂ≠êË°®Ê†ºÊäìÂèñ„ÄåxxxxÂπ¥xxÊúà„Äç
       *******************************************************/
      function extractYearMonth(titleRow) {
        console.log("titleRow", titleRow);
        const match = titleRow[0].match(/(\d{4})Âπ¥(\d{1,2})Êúà/);
        if (match) {
          return { year: match[1], month: match[2] };
        }
        return { year: "", month: "" };
      }

      /*******************************************************
       * 6. Ë£úÂÖ®„ÄåÊó•ÊúüÊ¨Ñ‰Ωç„Äç„ÄåÂÖ≠‰∏ãÊ¨Ñ‰Ωç„Äç‰∏¶ÁßªÈô§ÊèõË°åÁ¨¶Ëôü
       *******************************************************/
      function fillDateAndSixDown(table) {
        // Ëã•Á¨¨‰∫åË°åÁ¨¨‰∏ÄÊ†ºÁÇ∫Á©∫ -> Ë°®È†≠ÂÖ©Ë°åÂêà‰Ωµ
        if (table.length >= 2 && table[1][0].trim() === "") {
          const secondHeader = table[1];
          for (let col = 0; col < secondHeader.length; col++) {
            const cellVal = secondHeader[col].trim();
            if (cellVal !== "") {
              table[0][col] = table[0][col].trim()
                ? table[0][col].trim() + "/" + cellVal
                : cellVal;
            }
          }
          table.splice(1, 1);
        }

        // Ë£úÂÖ®Ê®ôÈ†≠
        if (table.length > 0) {
          for (let col = 1; col < table[0].length; col++) {
            if (!table[0][col] || table[0][col].trim() === "") {
              table[0][col] = table[0][col - 1];
            }
          }
        }

        // ÂæûÁ¨¨‰∫åÂàóÈñãÂßã
        for (let i = 1; i < table.length; i++) {
          const row = table[i];
          const prevRow = table[i - 1];
          // Êó•ÊúüÊ¨ÑÁ©∫ -> Áî®‰∏ä‰∏ÄÂàóÊó•Êúü
          if (
            (!row[0] || row[0].trim() === "") &&
            prevRow[0] &&
            !isNaN(prevRow[0].trim())
          ) {
            row[0] = prevRow[0];
          }
          // Ëã•Á¨¨‰∫åÊ¨ÑÁÇ∫ "ÂÖ≠‰∏ã"Ôºå‰∏îÁ¨¨‰∏âÊ¨ÑÁ©∫ -> Áî®‰∏ä‰∏ÄÂàóÁ¨¨‰∏âÊ¨ÑË£ú
          if (row[1] && row[1].trim() === "ÂÖ≠‰∏ã") {
            if (!row[2] || row[2].trim() === "") {
              if (prevRow[2] && prevRow[2].trim() !== "") {
                row[2] = prevRow[2];
              }
            }
          }
        }

        // ÁßªÈô§ÊèõË°åÁ¨¶Ëôü
        for (let i = 0; i < table.length; i++) {
          for (let j = 0; j < table[i].length; j++) {
            table[i][j] = table[i][j].replace(/\n\s*/g, "");
          }
        }

        // Ëã•Á¨¨‰∏ÄÂàóÁ¨¨‰∫åÊ¨ÑÊòØ "ÊúÉÂæåÂ†±Âëä"ÔºåÈÅáÂà∞Á©∫ÂâáÁî®‰∏ä‰∏ÄÂàóË£ú
        if (table[0][1].replace("\n", "") === "ÊúÉÂæåÂ†±Âëä") {
          for (let i = 1; i < table.length; i++) {
            if (!table[i][1] || table[i][1].trim() === "") {
              table[i][1] = table[i - 1][1] || "";
            }
          }
        }

        console.log("Â°´Ë£ú‰∏¶Ê∏ÖÁêÜÂæåÁöÑË°®Ê†ºÔºö", table);
        return table;
      }

      /*******************************************************
       * 7. Ë®àÁÆóÁâπÂÆöÊó•ÊúüÁöÑÊòüÊúü & Ë®àÁÆóÊüêÊòüÊúüÂ∞çÊáâ‰πãÊâÄÊúâÊó•Êúü
       *******************************************************/
      function getWeekdayFromDate(year, month, dateNum) {
        const dt = new Date(year, month - 1, dateNum);
        return dt.getDay(); // 0=Êó•,1=‰∏Ä,...,6=ÂÖ≠
      }
      function getDatesForWeekday(year, month, weekdayNum) {
        const dates = [];
        const daysInMonth = new Date(year, month, 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
          const dt = new Date(year, month - 1, d);
          if (dt.getDay() === weekdayNum) {
            dates.push(d);
          }
        }
        return dates;
      }

      /*******************************************************
       * 8. Â∞áÂ§öË°®Ê†ºËΩâÁÇ∫„ÄåÂ∑•‰ΩúË°®Áâ©‰ª∂„Äç(‰ª•‰∫∫ÂêçÁÇ∫ key)
       *******************************************************/
      function tablesToWork(finalTables, { year, month }) {
        const workSheet = {};
        const validWeekdays = ["Êó•", "‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠"];
        const weekdayMapping = {
          Êó•: 0,
          ‰∏Ä: 1,
          ‰∫å: 2,
          ‰∏â: 3,
          Âõõ: 4,
          ‰∫î: 5,
          ÂÖ≠: 6,
        };

        finalTables.forEach((table) => {
          // Ê™¢Êü•Á¨¨‰∏ÄÂàóÁ¨¨‰∏ÄÊ†ºÔºåÂà§Êñ∑Ê®°Âºè
          if (table[0][0] === "Êó•Êúü") {
            // Êó•ÊúüÊ®°Âºè
            let hasWeekday = false;
            if (table[0][1] === "ÊòüÊúü") {
              hasWeekday = true;
            }
            const workStartIndex = hasWeekday ? 2 : 1;

            for (let i = 1; i < table.length; i++) {
              const dateVal = table[i][0];
              for (let j = workStartIndex; j < table[i].length; j++) {
                const cellVal = table[i][j].trim();
                if (cellVal === "" || cellVal === "-") continue;

                // Â§ö‰∫∫ÂàÜÈÖçÔºàJGC ÁâπÂåñÔºâ
                if (/\s|‚à£/.test(cellVal)) {
                  const multiplePersons = splitNamesJGC(cellVal);
                  multiplePersons.forEach((personName) => {
                    const clean = personName.trim().replace(/\s+/g, "");
                    if (!clean) return;
                    const key = clean;
                    if (!workSheet[key]) workSheet[key] = [];
                    workSheet[key].push({
                      date: dateVal,
                      weekDay: hasWeekday
                        ? table[i][1]
                        : validWeekdays[
                            getWeekdayFromDate(year, month, dateVal)
                          ],
                      work: table[0][j],
                    });
                  });
                } else {
                  // ÂñÆ‰∏ÄË≤†Ë≤¨‰∫∫
                  const cleanName = cellVal.trim().replace(/\s+/g, "");
                  const key = cleanName;
                  if (!workSheet[key]) {
                    workSheet[key] = [];
                  }
                  workSheet[key].push({
                    date: dateVal,
                    weekDay: hasWeekday
                      ? table[i][1]
                      : validWeekdays[getWeekdayFromDate(year, month, dateVal)],
                    work: table[0][j],
                  });
                }
              }
            }
          } else if (table[0][0] === "ÊòüÊúü") {
            // ÊòüÊúüÊ®°Âºè
            for (let i = 1; i < table.length; i++) {
              for (let j = 1; j < table[i].length; j++) {
                const person = table[i][j].trim().replace(/\s+/g, "");
                if (person === "" || person === "-") continue;
                const targetWeekday = table[i][0];
                if (!validWeekdays.includes(targetWeekday[0])) {
                  console.warn("ÂÅµÊ∏¨Âà∞ÁÑ°ÊïàÊòüÊúü:", targetWeekday);
                  continue;
                }
                const possibleDates = getDatesForWeekday(
                  year,
                  month,
                  weekdayMapping[targetWeekday[0]]
                );
                possibleDates.forEach((d) => {
                  if (!workSheet[person]) {
                    workSheet[person] = [];
                  }
                  workSheet[person].push({
                    date: d.toString(),
                    weekDay: targetWeekday,
                    work: table[0][j],
                  });
                });
              }
            }
          } else {
            console.error(
              "Ë°®Ê†ºÁ¨¨‰∏ÄÂàóÁ¨¨‰∏ÄÊ†ºÊó¢‰∏çÊòØ„ÄéÊó•Êúü„Äè‰πü‰∏çÊòØ„ÄéÊòüÊúü„ÄèÔºåÂøΩÁï•ËôïÁêÜÔºö",
              table[0]
            );
          }
        });
        return workSheet;
      }

      /**
       * Â∞á workSheet ‰∏≠ÊØèÂÄã‰∫∫ÁöÑÂ∑•‰ΩúÈ†ÖÁõÆÔºå
       * Âæû { date, weekDay, work } ËΩâÁÇ∫ { date, timeSlot, task }Ôºå
       * ‰∏¶Ë∑≥ÈÅé‰ªª‰ΩïÊúâ undefined Ê¨Ñ‰ΩçÁöÑÈ†ÖÁõÆ„ÄÇ
       *
       * @param {Object} workSheet - ÂéüÂßãÁöÑÂ∑•‰ΩúË°®Áâ©‰ª∂Ôºå‰æãÂ¶ÇÔºö
       * {
       *   "ÁéãÂ∞èÊòé": [
       *     { date: "12", weekDay: "‰∏â", work: "ÊúÉÂâçÈ†òË©©" },
       *     { date: "12", weekDay: "‰∏â", work: "ÁøªË≠Ø" },
       *     { date: undefined, weekDay: "‰∏â", work: "ÂÖ∂‰ªñ" } // ÈÄôÁ≠ÜÊúÉË¢´Ë∑≥ÈÅé
       *   ],
       *   "ÊùéÂ§ßËèØ": [
       *     { date: "15", weekDay: "ÂÖ≠‰∏ã", work: "Âè∏Áê¥" }
       *   ]
       * }
       * @returns {Object} - ËΩâÊèõÂæåÁöÑÂ∑•‰ΩúË°®Áâ©‰ª∂ÔºåÁµêÊßãÁÇ∫Ôºö
       * {
       *   "ÁéãÂ∞èÊòé": [
       *     { date: "12", timeSlot: "‰∏â", task: "ÊúÉÂâçÈ†òË©©" },
       *     { date: "12", timeSlot: "‰∏â", task: "ÁøªË≠Ø" }
       *   ],
       *   "ÊùéÂ§ßËèØ": [
       *     { date: "15", timeSlot: "ÂÖ≠‰∏ã", task: "Âè∏Áê¥" }
       *   ]
       * }
       */
      function transformWorkSheet(workSheet) {
        const transformedSheet = {};
        for (const personName in workSheet) {
          // ÂéªÈô§ personName ‰∏≠ÁöÑÊâÄÊúâÊñúÁ∑ö
          const cleanPersonName = personName.replace(/\//g, "");
          transformedSheet[cleanPersonName] = workSheet[personName].reduce(
            (acc, item) => {
              // Ê™¢Êü•ÊòØÂê¶Êúâ‰ªª‰ΩïÊ¨Ñ‰ΩçÁÇ∫ undefined
              if (
                item.date !== undefined &&
                item.weekDay !== undefined &&
                item.work !== undefined
              ) {
                acc.push({
                  date: item.date,
                  timeSlot: item.weekDay,
                  task: item.work,
                });
              }
              return acc;
            },
            []
          );
        }
        return transformedSheet;
      }

      /*******************************************************
       * ÂÖ®ÂüüËÆäÊï∏ÔºöÂÑ≤Â≠ò„ÄåÊúÄÁµÇÁöÑËΩâÊèõÂæåÂ∑•‰ΩúË°®Áâ©‰ª∂„Äç
       *******************************************************/
      let finalTransformedSheet = null;

      // === Âà™Èô§/Âæ©ÂéüÁöÑÂÖ®ÂüüÁãÄÊÖã ===
      let deletedJobsByUser = {}; // { userName: Set<jobIdString> }
      const makeJobId = (job) => `${job.date}__${job.timeSlot}__${job.task}`; // Á©©ÂÆöID

      // ‰æõ JSON Modal ‰ΩøÁî®
      let parsedFinalTables = null; // Ëß£ÊûêÂæåÁöÑ Table Èô£Âàó

      // ÁØ©ÈÅ∏ÁãÄÊÖã
      let currentTaskFilter = "ALL";

      // ‰æùÁõÆÂâçÂèØË¶ãÂ∑•‰ΩúÔºàÊéíÈô§Â∑≤Âà™Èô§ÔºâÊî∂ÈõÜÊâÄÊúâÂ∑•‰ΩúÈ†ÖÁõÆ
      function collectVisibleTasks() {
        if (!finalTransformedSheet) return [];
        const tasks = new Set();
        for (const [user, jobs] of Object.entries(finalTransformedSheet)) {
          const delSet = deletedJobsByUser[user] || new Set();
          jobs.forEach((job) => {
            if (!delSet.has(makeJobId(job))) tasks.add(job.task);
          });
        }
        return Array.from(tasks).sort();
      }

      // Êõ¥Êñ∞‰∏ãÊãâÈÅ∏È†Ö
      function refreshTaskFilterOptions() {
        const sel = document.getElementById("jobFilterSelect");
        if (!sel) return;
        // Ê∏ÖÁ©∫‰∏¶ÈáçÂª∫
        sel.innerHTML = `<option value="ALL">ÔºàÂÖ®ÈÉ®Â∑•‰ΩúÔºâ</option>`;
        const tasks = collectVisibleTasks();
        tasks.forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          sel.appendChild(opt);
        });
        sel.disabled = !finalTransformedSheet || tasks.length === 0;
        // Ëã•ÁõÆÂâçÈÅ∏ÁöÑÂÄº‰∏çÂ≠òÂú®‰∫ÜÔºåÂ∞±ÂõûÂà∞ ALL
        const values = new Set(tasks.concat(["ALL"]));
        if (!values.has(currentTaskFilter)) {
          currentTaskFilter = "ALL";
          sel.value = "ALL";
        } else {
          sel.value = currentTaskFilter;
        }
      }

      function updateJsonModalContent(content) {
        const pre = document.getElementById("jsonOutput");
        if (!pre) return;
        if (typeof content === "string") {
          pre.textContent = content;
        } else {
          try {
            pre.textContent = JSON.stringify(content, null, 2);
          } catch {
            pre.textContent = String(content ?? "ÔºàÁÑ°ÂÖßÂÆπÔºâ");
          }
        }
      }

      function ensureDeletedSet(user) {
        if (!deletedJobsByUser[user]) deletedJobsByUser[user] = new Set();
      }

      // ÈÅéÊøæÔºöÊää finalTransformedSheet ‰∏≠Ë¢´Âà™Èô§ÁöÑÂ∑•‰ΩúÊéíÈô§ÔºåÂõûÂÇ≥Ë¶Å‰∏äÂÇ≥ÁöÑ payload
      function buildUploadPayload() {
        if (!finalTransformedSheet) return null;
        const result = {};
        for (const [user, jobs] of Object.entries(finalTransformedSheet)) {
          const delSet = deletedJobsByUser[user] || new Set();
          const kept = jobs.filter((job) => !delSet.has(makeJobId(job)));
          if (kept.length > 0) result[user] = kept;
        }
        return result;
      }

      // UIÔºöÊ∏≤Êüì‰ΩøÁî®ËÄÖÁöÑ„ÄåÂèØË¶ãÂ∑•‰Ωú„Äç
      function renderUserJobs() {
        const container = document.getElementById("userJobs");
        container.innerHTML = "";
        if (!finalTransformedSheet) {
          container.innerHTML = `<div style="text-align:center;color:var(--muted);padding:20px">Â∞öÊú™Áî¢ÁîüÂ∑•‰ΩúÊ∏ÖÂñÆ</div>`;
          // Ê≤íË≥áÊñôÊôÇÂêåÊ≠•Êõ¥Êñ∞ÈÅ∏ÂñÆÁãÄÊÖã
          refreshTaskFilterOptions();
          return;
        }

        // ÂÖàÁÆóÂá∫ÊØè‰Ωç‰ΩøÁî®ËÄÖÁöÑÂèØË¶ãÂ∑•‰ΩúÔºàÊéíÈô§Â∑≤Âà™Èô§Ôºâ
        const visibleByUser = {};
        for (const [user, jobs] of Object.entries(finalTransformedSheet)) {
          const delSet = deletedJobsByUser[user] || new Set();
          visibleByUser[user] = jobs.filter(
            (job) => !delSet.has(makeJobId(job))
          );
        }

        // Ëã•ÊúâÁØ©ÈÅ∏ÔºöÂè™Áïô‰∏ã„ÄåÊúâË©≤Â∑•‰Ωú„ÄçÁöÑ‰ΩøÁî®ËÄÖÔºå‰ΩÜ‰ªçÈ°ØÁ§∫‰ªñÂÄëÁöÑÊâÄÊúâÂèØË¶ãÂ∑•‰Ωú
        const taskFilter = currentTaskFilter;
        const filteredUsers = Object.entries(visibleByUser).filter(
          ([user, jobs]) => {
            if (taskFilter === "ALL") return true;
            return jobs.some((j) => j.task === taskFilter);
          }
        );

        if (filteredUsers.length === 0) {
          container.innerHTML = `<div style="text-align:center;color:var(--muted);padding:20px">Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑÊàêÂì°</div>`;
          refreshTaskFilterOptions(); // ÂêåÊ≠•Êõ¥Êñ∞ÈÅ∏ÂñÆ
          return;
        }

        filteredUsers.forEach(([user, visibleJobs]) => {
          const card = document.createElement("div");
          card.className = "user-card";
          const title = document.createElement("h4");
          title.textContent = user;
          card.appendChild(title);

          if (visibleJobs.length === 0) {
            const empty = document.createElement("div");
            empty.textContent = "ÔºàÊú¨ÊúàÁÑ°Â∑•‰ΩúÔºâ";
            card.appendChild(empty);
          } else {
            const ul = document.createElement("ul");
            ul.className = "user-job-list";
            visibleJobs.forEach((job) => {
              const li = document.createElement("li");
              li.innerHTML = `üìÖ ${job.date}ÔΩú${job.timeSlot}ÔΩú${job.task}
                <button class="btn danger" 
                        data-action="delete" 
                        data-user="${user}"
                        data-id="${makeJobId(job)}"
                        style="float:right;padding:4px 8px;font-size:12px;">Âà™Èô§</button>`;
              ul.appendChild(li);
            });
            card.appendChild(ul);
          }
          container.appendChild(card);
        });

        // ÊØèÊ¨°ÈáçÁπ™ÂæåÔºåÊõ¥Êñ∞‰∏ãÊãâÈÅ∏ÂñÆÔºàËÆìÂèØÈÅ∏È†ÖÁõÆË∑üËëóÂà™Èô§/Âæ©ÂéüËÆäÂãïÔºâ
        refreshTaskFilterOptions();
      }

      // UIÔºöÊ∏≤Êüì„ÄåÂ∑≤Âà™Èô§Â∑•‰ΩúÂçÄÂüü„ÄçÔºàÂèØÂæ©ÂéüÔºâ
      function renderDeletedJobs() {
        const container = document.getElementById("deletedJobs");
        container.innerHTML = "";

        // ËíêÈõÜÊØè‰Ωç‰ΩøÁî®ËÄÖÁöÑÂ∑≤Âà™Èô§È†ÖÁõÆ
        const blocks = [];
        for (const [user, jobs] of Object.entries(
          finalTransformedSheet || {}
        )) {
          const delSet = deletedJobsByUser[user] || new Set();
          const deletedList = jobs.filter((job) => delSet.has(makeJobId(job)));
          if (deletedList.length > 0) {
            blocks.push({ user, deletedList });
          }
        }

        if (blocks.length === 0) {
          container.innerHTML = `<div style="text-align:center;color:var(--muted);padding:20px">Â∞öÁÑ°Â∑≤Âà™Èô§ÁöÑÂ∑•‰Ωú</div>`;
          return;
        }

        blocks.forEach(({ user, deletedList }) => {
          const card = document.createElement("div");
          card.className = "user-card";
          const title = document.createElement("h4");
          title.textContent = `${user}ÔºàÂ∑≤Âà™Èô§Ôºâ`;
          card.appendChild(title);

          const ul = document.createElement("ul");
          ul.className = "user-job-list";
          deletedList.forEach((job) => {
            const li = document.createElement("li");
            li.innerHTML = `üìÖ ${job.date}ÔΩú${job.timeSlot}ÔΩú${job.task}
              <button class="btn" 
                      data-action="restore" 
                      data-user="${user}"
                      data-id="${makeJobId(job)}"
                      style="float:right;padding:4px 8px;font-size:12px;">Âæ©Âéü</button>`;
            ul.appendChild(li);
          });
          card.appendChild(ul);
          container.appendChild(card);
        });
      }

      /*******************************************************
       * Toast Ë®äÊÅØÁ≥ªÁµ±
       *******************************************************/
      function showToast(message, type = "info", duration = 3000) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
        }, duration);
      }

      /*******************************************************
       * ÂàùÂßãÂåñÂúñÁâá‰∏äÂÇ≥ÂäüËÉΩÔºöÁîüÊàêÂπ¥Êúà‰∏ãÊãâÈÅ∏ÂñÆ
       *******************************************************/
      function initializeImageUpload() {
        const select = document.getElementById("imageMonthSelect");
        const currentDate = new Date();

        // ÁîüÊàê -3 Âà∞ +6 ÂÄãÊúàÁöÑÈÅ∏È†Ö
        for (let i = -3; i <= 6; i++) {
          const targetDate = new Date(
            currentDate.getFullYear(),
            currentDate.getMonth() + i,
            1
          );
          const year = targetDate.getFullYear();
          const month = (targetDate.getMonth() + 1).toString().padStart(2, "0");
          const yearMonth = `${year}${month}`;

          const option = document.createElement("option");
          option.value = yearMonth;
          option.textContent = `${year}Âπ¥${month}Êúà (${yearMonth})`;

          // Â¶ÇÊûúÊòØÁï∂ÂâçÊúà‰ªΩÔºåË®≠ÁÇ∫È†êË®≠ÈÅ∏È†Ö
          if (i === 0) {
            option.selected = true;
          }

          select.appendChild(option);
        }
      }

      // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñ
      document.addEventListener("DOMContentLoaded", function () {
        initializeImageUpload();
        initializeUploadTypeHandler();

        // Á∂ÅÂÆöÁØ©ÈÅ∏‰∏ãÊãâ‰∫ã‰ª∂
        const sel = document.getElementById("jobFilterSelect");
        if (sel) {
          sel.addEventListener("change", () => {
            currentTaskFilter = sel.value || "ALL";
            renderUserJobs(); // ÊúÉËÆÄ currentTaskFilter
          });
        }
      });

      // JSON Modal ÈñãÈóú
      (function setupJsonModal() {
        const backdrop = document.getElementById("jsonModalBackdrop");
        const closeBtn = document.getElementById("jsonModalCloseBtn");
        const closeBtn2 = document.getElementById("jsonModalCloseBtn2");
        function openModal() {
          backdrop.style.display = "flex";
          backdrop.setAttribute("aria-hidden", "false");
        }
        function closeModal() {
          backdrop.style.display = "none";
          backdrop.setAttribute("aria-hidden", "true");
        }
        closeBtn.addEventListener("click", closeModal);
        closeBtn2.addEventListener("click", closeModal);
        backdrop.addEventListener("click", (e) => {
          if (e.target === backdrop) closeModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && backdrop.style.display === "flex")
            closeModal();
        });

        // „ÄåÊü•ÁúãËß£Êûê JSON„ÄçÊåâÈàï
        document
          .getElementById("openJsonModalBtn")
          .addEventListener("click", () => {
            if (!parsedFinalTables) {
              showToast(
                "Â∞öÊú™ÈÄ≤Ë°åË≥áÊñôËß£ÊûêÔºåË´ãÂÖàÈªûÊìä„ÄéÊäìÂèñË≥áÊñô‰∏¶Ëß£Êûê„Äè„ÄÇ",
                "error"
              );
              return;
            }
            updateJsonModalContent(parsedFinalTables);
            openModal();
          });
      })();

      /*******************************************************
       * ÂàùÂßãÂåñ‰∏äÂÇ≥È°ûÂûãËÆäÊõ¥ËôïÁêÜ
       *******************************************************/
      function initializeUploadTypeHandler() {
        const uploadTypeSelect = document.getElementById("uploadTypeSelect");
        const monthSelectContainer = document.getElementById(
          "monthSelectContainer"
        );

        // Ë®≠ÂÆöËÆäÊõ¥‰∫ã‰ª∂Áõ£ËÅΩÂô®
        uploadTypeSelect.addEventListener("change", function () {
          const selectedType = this.value;

          if (selectedType === "schedule") {
            // ÈÅ∏ÊìáÂÆâÊéíË°®ÊôÇÈ°ØÁ§∫Âπ¥ÊúàÈÅ∏È†Ö
            monthSelectContainer.style.display = "block";
          } else {
            // ÈÅ∏ÊìáÁè≠Á¥öÊôÇÈö±ËóèÂπ¥ÊúàÈÅ∏È†Ö
            monthSelectContainer.style.display = "none";
          }
        });

        // ÂàùÂßãÂåñÊôÇÊ†πÊìöÈ†êË®≠ÂÄºË®≠ÂÆöÈ°ØÁ§∫ÁãÄÊÖã
        const initialType = uploadTypeSelect.value;
        if (initialType === "schedule") {
          monthSelectContainer.style.display = "block";
        } else {
          monthSelectContainer.style.display = "none";
        }
      }

      /*******************************************************
       * ‰∫ã‰ª∂ÔºöËß£ÊûêÁ∂≤ÂùÄ ‚Üí Â°´ÂÖ• sheetId/gid
       *******************************************************/
      document
        .getElementById("parseButton")
        .addEventListener("click", function () {
          const url = document.getElementById("urlInput").value.trim();
          if (!url) {
            alert("Ë´ãË≤º‰∏äÊúâÊïàÁöÑ Google Ë©¶ÁÆóË°®Á∂≤ÂùÄÊàñ Sheet IDÔºÅ");
            return;
          }
          const { sheetId, gid } = parseSpreadsheetUrl(url);
          if (!sheetId) {
            alert("ÁÑ°Ê≥ïËß£ÊûêÂá∫ sheetIdÔºåË´ãÁ¢∫Ë™çÁ∂≤ÂùÄÊòØÂê¶Ê≠£Á¢∫„ÄÇ");
            return;
          }
          document.getElementById("sheetIdInput").value = sheetId;
          document.getElementById("gidInput").value = gid;
        });

      /*******************************************************
       * ‰∫ã‰ª∂ÔºöÊäìÂèñ CSV ‚Üí Papa Parse ‚Üí ÂàáÂâ≤ ‚Üí Ë£úÂÖ® ‚Üí ËΩâÊèõ
       *******************************************************/
      document
        .getElementById("fetchButton")
        .addEventListener("click", function () {
          const sheetId = document.getElementById("sheetIdInput").value.trim();
          const gid = document.getElementById("gidInput").value.trim();
          showToast("Ëß£Êûê‰∏≠...", "info");

          if (!sheetId) {
            alert("Ë´ãÂÖàÂ°´ÂÖ• sheetIdÔºÅ");
            return;
          }
          const finalGid = gid || "0";
          const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&id=${sheetId}&gid=${finalGid}`;

          fetch(csvUrl)
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.text();
            })
            .then((csvText) => {
              // 1) Papa Parse
              const parsedCsv = Papa.parse(csvText);

              // 2) ËéíÂÖâÊïôÊúÉÁâπÂåñÔºöÁ´ãÂç≥ËôïÁêÜÊé•ÂæÖ‰∫∫Âì°Ëá™ÂãïË£úÂÖ®ÔºàË≥áÊñô‰∏ÄÈÄ≤‰æÜÂ∞±Âü∑Ë°åÔºâ
              const processedData = jgtjcProcessReceptionist(parsedCsv.data);
              console.log("Á´ãÂç≥ËôïÁêÜÊé•ÂæÖ‰∫∫Âì°ÂæåÁöÑÂéüÂßãË≥áÊñôÔºö", processedData);

              // 3) ËéíÂÖâÊïôÊúÉÁâπÂåñÔºöËá™ÂãïÂ°´ÂÖ•Ë•øÂÖÉÂπ¥Êúà‰ªΩ
              jgtjcAutoFillYearMonth(parsedCsv.data);

              // 3) Ê∞¥Âπ≥Á©∫ÁôΩË°å + ÂûÇÁõ¥Á©∫ÁôΩÊ¨Ñ
              const tableBlocks =
                splitTablesByEmptyRowsAndColumns(processedData);

              // 4) ‰æùÊó•Êúü/ÊòüÊúüÈóúÈçµÂ≠óÂÜçÂàáÂâ≤
              const dateSubTables = splitTablesByDateKeyword(tableBlocks);

              // 5) Êî§Âπ≥ÊàêÂñÆ‰∏ÄÈô£Âàó
              const flatTables = [];
              dateSubTables.forEach((blocks) => {
                blocks.forEach((subTable) => {
                  flatTables.push(subTable);
                });
              });

              // ÁßªÈô§ÊâÄÊúâÁ©∫ÁöÑÁõ¥Ë°å
              function removeEmptyColumns(table) {
                if (!table.length) return table;
                const colCount = table[0].length;
                // ÊâæÂá∫Âì™‰∫õÊ¨Ñ‰ΩçÊòØÂÖ®Á©∫
                const emptyCols = [];
                for (let col = 0; col < colCount; col++) {
                  let allEmpty = true;
                  for (let row = 0; row < table.length; row++) {
                    if (table[row][col] && table[row][col].trim() !== "") {
                      allEmpty = false;
                      break;
                    }
                  }
                  if (allEmpty) emptyCols.push(col);
                }
                // Âª∫Á´ãÊñ∞ÁöÑ tableÔºåÁßªÈô§Á©∫Ê¨Ñ
                return table.map((row) =>
                  row.filter((_, idx) => !emptyCols.includes(idx))
                );
              }

              const validFlatTables = flatTables
                .map(removeEmptyColumns)
                .filter((table) =>
                  table.some((row) => row.some((cell) => cell !== ""))
                );

              console.log("ÁßªÈô§ÊâÄÊúâÁ©∫ÁöÑÁõ¥Ë°åÂæåÁöÑË°®Ê†ºÔºö", validFlatTables);

              // 6) ÂæûÁ¨¨‰∏ÄÂÄãÂ≠êË°®Ê†ºÊäìÂèñ yearMonth (Ëã•ÂèØÂèñÂæó)
              const yearMonth = extractYearMonth(validFlatTables[0][0]);
              console.log("yearMonth", yearMonth);

              // 7) ÁØ©ÈÅ∏Âá∫Á¨¨‰∏ÄÂàóÁ¨¨‰∏ÄÊ†ºÁÇ∫„ÄåÊó•Êúü„ÄçÊàñ„ÄåÊòüÊúü„ÄçÁöÑË°®Ê†º
              const validTables = validFlatTables.filter((table) => {
                if (table[0].length === 0) return false;
                const firstCell = table[0][0].trim();
                return firstCell === "Êó•Êúü" || firstCell === "ÊòüÊúü";
              });
              console.log("ÊúâÊïàÂÆâÊéíË°®Ôºö", validTables);

              // ÊúâÊïàÂÆâÊéíË°®ÊáâÁÇ∫2‰ªΩ Â¶ÇÊûúÊ≤íÊúâ Ë¶ÅÊèêÁ§∫
              if (validTables.length !== 2) {
                alert("ÊúâÊïàÂÆâÊéíË°®ÊáâÁÇ∫2‰ªΩ ÁõÆÂâçÊï∏ÈáèÊúâË™§ Ë´ãÈÄ≤Ë°åÈ°çÂ§ñÁ¢∫Ë™ç");
              }

              // 8) Ë£úÂÖ®Ê¨Ñ‰Ωç
              const finalTables = validTables.map((table) =>
                fillDateAndSixDown(table)
              );
              console.log("ÊúÄÁµÇËôïÁêÜÂæåÁöÑË°®Ê†ºÔºö", finalTables);

              // 8) ËΩâÊèõÊàê workSheet
              const workSheet = tablesToWork(finalTables, yearMonth);
              console.log("ÂéüÂßãÂ∑•‰ΩúË°®Áâ©‰ª∂Ôºö", workSheet);

              // 9) ÈÄ≤‰∏ÄÊ≠•ËΩâÊàê { date, timeSlot, task }
              finalTransformedSheet = transformWorkSheet(workSheet);
              console.log("ËΩâÊèõÂæåÁöÑÂ∑•‰ΩúË°®Áâ©‰ª∂Ôºö", finalTransformedSheet);

              // 10) ËéíÂÖâÊïôÊúÉÁâπÂåñÔºöËôïÁêÜÊ∏ÖÊéÉÂçÄÂüüÂíåÁí∞Â¢ÉÊ∏ÖÊΩîÁöÑÈóúËÅØ
              finalTransformedSheet = jgtjcProcessCleaningArea(
                finalTransformedSheet
              );

              // Ëß£ÊûêÂÆåÊàêÔºöÈáçÁπ™ UIÔºàÂèØÂà™Èô§/Âæ©ÂéüÔºâ
              deletedJobsByUser = {}; // Ê∏ÖÁ©∫‰πãÂâçÁöÑÂà™Èô§ÁãÄÊÖã
              renderUserJobs();
              renderDeletedJobs();

              // Êõ¥Êñ∞ JSON Modal ÁöÑË≥áÊñô
              parsedFinalTables = finalTables;
              updateJsonModalContent(parsedFinalTables);
              showToast("Ëß£ÊûêÂÆåÊàêÔºÅ", "success");
            })
            .catch((error) => {
              console.error(error);
              parsedFinalTables = null;
              updateJsonModalContent(
                "ÊäìÂèñÊàñËß£ÊûêË≥áÊñôÊôÇÁôºÁîüÈåØË™§Ôºö" + error.message
              );
              showToast("ÊäìÂèñÊàñËß£ÊûêÂ§±Êïó", "error");
            });
        });

      /*******************************************************
       * ‰∫ã‰ª∂ÔºöÂ∞á finalTransformedSheet ‰∏äÂÇ≥Ëá≥ Firebase
       *******************************************************/
      document
        .getElementById("uploadBtn")
        .addEventListener("click", function () {
          const month = document.getElementById("monthInput").value.trim();
          if (!month || !/^\d{6}$/.test(month)) {
            alert("Ë´ãËº∏ÂÖ•Ê≠£Á¢∫Ê†ºÂºèÁöÑÊúà‰ªΩ (yyyymm)");
            return;
          }
          if (!finalTransformedSheet) {
            alert("Â∞öÊú™ÁîüÊàêÂ∑•‰ΩúË°®Ë≥áÊñôÔºåË´ãÂÖà„ÄéÊäìÂèñË≥áÊñô‰∏¶Ëß£Êûê„ÄèÔºÅ");
            return;
          }

          const path = `line/schedule/jgtjc/${month}`;
          const payload = buildUploadPayload();
          if (!payload || Object.keys(payload).length === 0) {
            return alert("ÁõÆÂâçÊ≤íÊúâÂèØ‰∏äÂÇ≥ÁöÑÂ∑•‰ΩúÔºàÂèØËÉΩÂÖ®ÈÉ®Ë¢´Âà™Èô§Ôºâ");
          }
          database.ref(path).set(payload, function (error) {
            if (error) {
              alert("‰∏äÂÇ≥Â§±ÊïóÔºö" + error);
            } else {
              alert("ÊàêÂäü‰∏äÂÇ≥ÔºàÂ∑≤Ëá™ÂãïÊéíÈô§Â∑≤Âà™Èô§ÁöÑÂ∑•‰ΩúÔºâÔºÅ");
            }
          });
        });

      /*******************************************************
       * Âà™Èô§ÂäüËÉΩÈÅ∏ÂñÆÔºàModalÔºâÈÇèËºØ
       *******************************************************/
      (function setupDeleteMenu() {
        const backdrop = document.getElementById("deleteModalBackdrop");
        const openBtn = document.getElementById("openDeleteMenuBtn");
        const closeBtn = document.getElementById("deleteModalCloseBtn");
        const cancelBtn = document.getElementById("deleteModalCancelBtn");
        const doDeleteBtn = document.getElementById("doDeleteBtn");

        const modeSelect = document.getElementById("deleteModeSelect");
        const monthRow = document.getElementById("deleteMonthRow");
        const monthInput = document.getElementById("deleteMonthInput2");
        const classRow = document.getElementById("deleteClassRow");
        const classSelect = document.getElementById("deleteClassSelect");

        function openModal() {
          backdrop.style.display = "flex";
          backdrop.setAttribute("aria-hidden", "false");
          // È†êË®≠Â∏∂ÂÖ•Áï´Èù¢‰∏äÂ∑≤ÊúâÁöÑÊúà‰ªΩÈÅ∏ÊìáÔºàËã•ÊúâÔºâ
          const monthFromMain =
            document.getElementById("monthInput")?.value?.trim() ||
            document.getElementById("imageMonthSelect")?.value?.trim() ||
            "";
          if (!monthInput.value && monthFromMain)
            monthInput.value = monthFromMain;
        }
        function closeModal() {
          backdrop.style.display = "none";
          backdrop.setAttribute("aria-hidden", "true");
        }

        // È°ØÁ§∫Ê¨Ñ‰ΩçÈö®Ê®°ÂºèÂàáÊèõ
        function refreshFields() {
          const mode = modeSelect.value;
          if (mode === "scheduleData" || mode === "scheduleImage") {
            monthRow.style.display = "block";
            classRow.style.display = "none";
          } else if (mode === "classImage") {
            monthRow.style.display = "none";
            classRow.style.display = "block";
          }
        }

        // Â§ñÂ±§‰∫íÂãï
        openBtn.addEventListener("click", openModal);
        closeBtn.addEventListener("click", closeModal);
        cancelBtn.addEventListener("click", closeModal);
        backdrop.addEventListener("click", (e) => {
          if (e.target === backdrop) closeModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && backdrop.style.display === "flex")
            closeModal();
        });
        modeSelect.addEventListener("change", refreshFields);
        refreshFields();

        // ÂØ¶ÈöõÂà™Èô§
        doDeleteBtn.addEventListener("click", async function () {
          const mode = modeSelect.value;

          try {
            if (mode === "scheduleData") {
              const m = monthInput.value.trim();
              if (!/^\d{6}$/.test(m))
                return alert("Ë´ãËº∏ÂÖ•Ê≠£Á¢∫Ê†ºÂºèÁöÑÊúà‰ªΩ (yyyymm)");
              const path = `line/schedule/jgtjc/${m}`;
              if (!confirm(`Á¢∫ÂÆöÂà™Èô§„ÄåÂÆâÊéíË°®Ë≥áÊñô„ÄçÔºü\nË∑ØÂæëÔºö${path}`)) return;
              await database.ref(path).remove();
              alert(`Â∑≤Âà™Èô§Ôºö${path}`);
            } else if (mode === "scheduleImage") {
              const m = monthInput.value.trim();
              if (!/^\d{6}$/.test(m))
                return alert("Ë´ãËº∏ÂÖ•Ê≠£Á¢∫Ê†ºÂºèÁöÑÊúà‰ªΩ (yyyymm)");
              const path = `line/schedule/jgtjc/schedule_image/${m}`;
              if (!confirm(`Á¢∫ÂÆöÂà™Èô§„ÄåÂÆâÊéíË°®ÂúñÁâáÁ∂≤ÂùÄ„ÄçÔºü\nË∑ØÂæëÔºö${path}`))
                return;
              await database.ref(path).remove();
              alert(`Â∑≤Âà™Èô§Ôºö${path}`);
            } else if (mode === "classImage") {
              const cls = classSelect.value;
              if (!cls) return alert("Ë´ãÈÅ∏ÊìáÁè≠Á¥ö");
              const path = `line/schedule/jgtjc/class/${cls}`;
              if (!confirm(`Á¢∫ÂÆöÂà™Èô§„Äå${cls}„ÄçÁöÑÂúñÁâáÁ∂≤ÂùÄÔºü\nË∑ØÂæëÔºö${path}`))
                return;
              await database.ref(path).remove();
              alert(`Â∑≤Âà™Èô§Ôºö${path}`);
            } else {
              return alert("Êú™Áü•ÁöÑÂà™Èô§Ê®°Âºè");
            }
            closeModal();
          } catch (err) {
            alert(`Âà™Èô§Â§±ÊïóÔºö${err.message}`);
            return;
          }
        });
      })();

      /*******************************************************
       * ‰∫ã‰ª∂ÔºöÊ™¢Ë¶ñÂúñÁâáÈ†êË¶Ω
       *******************************************************/
      document
        .getElementById("previewImageBtn")
        .addEventListener("click", function () {
          const imageUrl = document
            .getElementById("imageUrlInput")
            .value.trim();

          if (!imageUrl) {
            showToast("Ë´ãÂÖàËº∏ÂÖ•ÂúñÁâáÁ∂≤ÂùÄÔºÅ", "error");
            return;
          }

          // Á∞°ÂñÆÁöÑÁ∂≤ÂùÄÊ†ºÂºèÈ©óË≠â
          try {
            new URL(imageUrl);
          } catch (e) {
            showToast("Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÁ∂≤ÂùÄÊ†ºÂºèÔºÅ", "error");
            return;
          }

          const previewContainer = document.getElementById(
            "imagePreviewContainer"
          );

          // Áõ¥Êé•È°ØÁ§∫ÂúñÁâáÔºå‰∏çÈÄ≤Ë°åÈ†êÂÖàËºâÂÖ•Ê∏¨Ë©¶
          previewContainer.style.display = "block";
          previewContainer.innerHTML = `
            <div style="border: 1px solid #2196f3; padding: 10px; border-radius: 4px; background: #e3f2fd;">
              <img 
                src="${imageUrl}" 
                style="max-width: 100%; max-height: 200px; border-radius: 4px; display: block; margin: 0 auto;" 
                onload="this.parentElement.style.borderColor='#4caf50'; this.parentElement.style.backgroundColor='#e8f5e8'; this.nextElementSibling.innerHTML='‚úÖ ÂúñÁâáËºâÂÖ•ÊàêÂäü<br><small style=\\'color:#666;\\'>Á∂≤ÂùÄÔºö${imageUrl}</small>'; this.nextElementSibling.style.color='#2e7d32';"
                onerror="this.style.display='none'; this.parentElement.style.borderColor='#ff9800'; this.parentElement.style.backgroundColor='#fff3e0'; this.nextElementSibling.innerHTML='‚ö†Ô∏è ÁÄèË¶ΩÂô®È†êË¶ΩÂ§±Êïó<br><small style=\\'font-size:0.8em;\\'>Â∏∏Ë¶ãÊñº imgur Á≠âÊúçÂãôÁöÑÂÆâÂÖ®ÈôêÂà∂<br><strong>Á∂≤ÂùÄÊú¨Ë∫´ÂèØËÉΩÊòØÊ≠£Á¢∫ÁöÑÔºåÂª∫Ë≠∞Áõ¥Êé•‰∏äÂÇ≥ÔºÅ</strong><br><br>Á∂≤ÂùÄÔºö${imageUrl}</small>'; this.nextElementSibling.style.color='#ef6c00';"
              />
              <div style="margin-top: 5px; font-size: 0.9em; color: #1976d2; text-align: center;">
                üîÑ ËºâÂÖ•ÂúñÁâá‰∏≠...
              </div>
            </div>
          `;
        });

      /*******************************************************
       * ‰∫ã‰ª∂ÔºöÂ∞áÂúñÁâáÁ∂≤ÂùÄ‰∏äÂÇ≥Ëá≥ Firebase
       *******************************************************/
      document
        .getElementById("uploadImageBtn")
        .addEventListener("click", function () {
          const imageUrl = document
            .getElementById("imageUrlInput")
            .value.trim();
          const selectedMonth =
            document.getElementById("imageMonthSelect").value;
          const uploadType = document.getElementById("uploadTypeSelect").value;

          if (!imageUrl) {
            alert("Ë´ãËº∏ÂÖ•ÂúñÁâáÁ∂≤ÂùÄÔºÅ");
            return;
          }

          // Á∞°ÂñÆÁöÑÁ∂≤ÂùÄÊ†ºÂºèÈ©óË≠â
          try {
            new URL(imageUrl);
          } catch (e) {
            alert("Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÁ∂≤ÂùÄÊ†ºÂºèÔºÅ");
            return;
          }

          if (!uploadType) {
            alert("Ë´ãÈÅ∏Êìá‰∏äÂÇ≥È°ûÂûãÔºÅ");
            return;
          }

          // Â¶ÇÊûúÊòØÂÆâÊéíË°®‰ΩÜÊ≤íÈÅ∏ÊìáÂπ¥ÊúàÔºåÊèêÁ§∫ÈåØË™§
          if (uploadType === "schedule" && !selectedMonth) {
            alert("Ë´ãÈÅ∏ÊìáÂπ¥ÊúàÔºÅ");
            return;
          }

          // Ê†πÊìö‰∏äÂÇ≥È°ûÂûãÊ±∫ÂÆöË∑ØÂæë
          let path;
          if (uploadType === "schedule") {
            path = `line/schedule/jgtjc/schedule_image/${selectedMonth}`;
          } else {
            path = `line/schedule/jgtjc/class/${uploadType}`;
          }

          database.ref(path).set(imageUrl, function (error) {
            if (error) {
              alert("‰∏äÂÇ≥Â§±ÊïóÔºö" + error);
            } else {
              alert(
                `ÊàêÂäü‰∏äÂÇ≥ÂúñÁâáÁ∂≤ÂùÄËá≥ FirebaseÔºÅ\nÈ°ûÂûãÔºö${
                  uploadType === "schedule" ? "ÂÆâÊéíË°®" : uploadType
                }\nË∑ØÂæëÔºö${path}\nÁ∂≤ÂùÄÔºö${imageUrl}`
              );
              // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê°ÜÂíåÈ†êË¶Ω
              document.getElementById("imageUrlInput").value = "";
              document.getElementById("imagePreviewContainer").style.display =
                "none";
            }
          });
        });

      // „Äå‰ΩøÁî®ËÄÖÂ∑•‰ΩúÊÉÖÂΩ¢„ÄçÂçÄÂ°äÔºöÂà™Èô§
      document.getElementById("userJobs").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action='delete']");
        if (!btn) return;
        const user = btn.getAttribute("data-user");
        const id = btn.getAttribute("data-id");
        ensureDeletedSet(user);
        deletedJobsByUser[user].add(id);
        renderUserJobs();
        renderDeletedJobs();
      });

      // „ÄåÂ∑≤Âà™Èô§Â∑•‰ΩúÂçÄÂüü„ÄçÔºöÂæ©Âéü
      document.getElementById("deletedJobs").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action='restore']");
        if (!btn) return;
        const user = btn.getAttribute("data-user");
        const id = btn.getAttribute("data-id");
        ensureDeletedSet(user);
        deletedJobsByUser[user].delete(id);
        renderUserJobs();
        renderDeletedJobs();
      });
    </script>
  </body>
</html>
