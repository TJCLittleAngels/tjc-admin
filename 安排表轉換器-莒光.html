<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>Google è©¦ç®—è¡¨ CSV è½‰æ› & Firebase ä¸Šå‚³</title>
    <!-- Papa Parse (CSV è§£æ) -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <!-- Firebase SDK (èˆŠç¨‹å¼ç¢¼åƒè€ƒ) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        max-height: 400px;
        overflow-y: auto;
      }
      input,
      button {
        padding: 8px;
        margin: 5px 0;
        font-size: 1em;
      }
      label {
        font-weight: bold;
      }
      .user-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin: 16px 0;
        padding: 16px 24px;
        max-width: 500px;
      }
      .user-card h4 {
        margin: 0 0 8px 0;
        color: #2a5d9f;
        font-size: 1.2em;
        letter-spacing: 1px;
      }
      .user-job-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .user-job-list li {
        padding: 6px 0;
        border-bottom: 1px solid #eee;
        font-size: 1em;
      }
      .user-job-list li:last-child {
        border-bottom: none;
      }
    </style>
  </head>
  <body>
    <h1>Google è©¦ç®—è¡¨ CSV è½‰æ› & Firebase ä¸Šå‚³</h1>

    <!-- Google Sheet ç›¸é—œ & åœ–ç‰‡ç¶²å€ä¸Šå‚³ -->
    <div style="display: flex; gap: 40px">
      <!-- å·¦åŠé‚Šï¼šGoogle Sheet è§£æ -->
      <div style="flex: 1">
        <label>(è’å…‰æ•™æœƒ)è©¦ç®—è¡¨ç¶²å€ / Sheet IDï¼š</label><br />
        <input
          type="text"
          id="urlInput"
          style="width: 100%"
          placeholder="è²¼ä¸Š Google è©¦ç®—è¡¨ç¶²å€æˆ–è¼¸å…¥ Sheet ID"
          value="https://docs.google.com/spreadsheets/d/1MiJOg52vv4ydrZpx6QxhfYy96Fy0uCZs/edit?gid=1775042568#gid=1775042568"
        />
        <button id="parseButton">è§£æç¶²å€</button>
        <br />
        <label>Sheet IDï¼š</label>
        <input
          type="text"
          id="sheetIdInput"
          placeholder="sheetId"
          style="width: 60%"
        />
        <br />
        <label>gidï¼š</label>
        <input type="text" id="gidInput" placeholder="gid" style="width: 60%" />
        <button id="fetchButton">æŠ“å–è³‡æ–™ä¸¦è§£æ</button>
      </div>

      <!-- å³åŠé‚Šï¼šåœ–ç‰‡ç¶²å€ä¸Šå‚³ -->
      <div style="flex: 1">
        <h3 style="margin-top: 0">ä¸Šå‚³åœ–ç‰‡ç¶²å€è‡³ Firebase</h3>
        <label>è«‹è¼¸å…¥åœ–ç‰‡ç¶²å€ï¼š</label><br />
        <div style="display: flex; gap: 5px; margin-bottom: 10px">
          <input
            type="url"
            id="imageUrlInput"
            placeholder="https://example.com/image.jpg"
            style="flex: 1"
          />
          <button id="previewImageBtn" style="padding: 8px 12px">
            æª¢è¦–åœ–ç‰‡
          </button>
        </div>

        <!-- åœ–ç‰‡é è¦½å€åŸŸ -->
        <div
          id="imagePreviewContainer"
          style="display: none; margin-bottom: 10px; text-align: center"
        >
          <div
            style="
              border: 1px solid #ddd;
              padding: 10px;
              border-radius: 4px;
              background: #f9f9f9;
            "
          >
            <img
              id="previewImage"
              style="max-width: 100%; max-height: 200px; border-radius: 4px"
            />
            <div style="margin-top: 5px; font-size: 0.9em; color: #666">
              åœ–ç‰‡é è¦½
            </div>
          </div>
        </div>

        <label>è«‹é¸æ“‡ä¸Šå‚³é¡å‹ï¼š</label><br />
        <select
          id="uploadTypeSelect"
          style="width: 100%; padding: 8px; margin: 5px 0; font-size: 1em"
        >
          <option value="schedule">å®‰æ’è¡¨</option>
          <option value="ä¸­ç´šç­">ä¸­ç´šç­</option>
          <option value="ä¿¡ä»°é€ å°±ç­">ä¿¡ä»°é€ å°±ç­</option>
          <option value="åˆç´šç­">åˆç´šç­</option>
          <option value="å°‘å¹´ç­">å°‘å¹´ç­</option>
          <option value="å¹¼å…’ç­">å¹¼å…’ç­</option>
          <option value="å¹¼å¹´ç­">å¹¼å¹´ç­</option>
        </select>
        <br />

        <div id="monthSelectContainer">
          <label>è«‹é¸æ“‡å¹´æœˆï¼š</label><br />
          <select
            id="imageMonthSelect"
            style="width: 100%; padding: 8px; margin: 5px 0; font-size: 1em"
          >
            <!-- å‹•æ…‹ç”Ÿæˆé¸é … -->
          </select>
          <br />
        </div>
        <button id="uploadImageBtn">ä¸Šå‚³åœ–ç‰‡ç¶²å€è‡³ Firebase</button>
      </div>
    </div>
    <br />

    <!-- è§£æçµæœé¡¯ç¤º -->
    <h3>è§£æå¾Œçš„è¡¨æ ¼ (JSON)ï¼š</h3>
    <pre id="output">å°šæœªè§£æ...</pre>

    <!-- Firebase ä¸Šå‚³åŠŸèƒ½ -->
    <hr />
    <h3>ä¸Šå‚³å·¥ä½œè¡¨è‡³ Firebase</h3>
    <label>è«‹è¼¸å…¥æœˆä»½ (æ ¼å¼ï¼šyyyymm)ï¼š</label><br />
    <input type="text" id="monthInput" placeholder="202503" />
    <button id="uploadBtn">ä¸Šå‚³å·¥ä½œè¡¨è‡³ Firebase</button>

    <h3>ä½¿ç”¨è€…å·¥ä½œæƒ…å½¢ï¼š</h3>
    <div id="userJobs"></div>

    <script>
      /*******************************************************
       * 1. Firebase åˆå§‹åŒ– (è«‹æ›æˆä½ è‡ªå·±çš„ Firebase config)
       *******************************************************/
      const firebaseConfig = {
        apiKey: "AIzaSyCGAdNce7wCJLPmqPZ4ID3PxvBDFDD8uSY",
        authDomain: "tjc-tw.firebaseapp.com",
        databaseURL:
          "https://tjc-tw-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tjc-tw",
        storageBucket: "tjc-tw.firebasestorage.app",
        messagingSenderId: "857954351277",
        appId: "1:857954351277:web:448c392836ef137e44ee24",
        measurementId: "G-Y3T47ZWQCB",
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      /*******************************************************
       * 2. è§£æ Google è©¦ç®—è¡¨ç¶²å€ï¼Œå–å¾— sheetId èˆ‡ gid
       *******************************************************/
      function parseSpreadsheetUrl(url) {
        let sheetId = "";
        let gid = "";
        const idMatch = url.match(/\/d\/([^/]+)/);
        if (idMatch && idMatch[1]) {
          sheetId = idMatch[1];
        }
        const gidMatch = url.match(/gid=([^&]+)/);
        if (gidMatch && gidMatch[1]) {
          gid = gidMatch[1];
        }
        return { sheetId, gid };
      }

      /*******************************************************
       * è’å…‰æ•™æœƒç‰¹åŒ–å‡½æ•¸ï¼šè™•ç†æ¥å¾…äººå“¡å’Œç‚Šäº‹è‡ªå‹•è£œå…¨
       *******************************************************/
      function jgtjcProcessReceptionist(data) {
        return data.map((row) => {
          return row.map((cell, cellIndex) => {
            if (cellIndex < row.length - 1) {
              const currentCell = cell.trim();
              const nextCell = row[cellIndex + 1].trim();

              // è™•ç†æ¥å¾…äººå“¡
              if (
                currentCell === "æ¥å¾…äººå“¡" &&
                (nextCell === "" || nextCell === "-")
              ) {
                row[cellIndex + 1] = "æ¥å¾…äººå“¡";
              }

              // è™•ç†ç‚Šäº‹ - è‡ªå‹•å¾€å¾Œé¢è£œå…©æ ¼ï¼ˆå¦‚æœæ˜¯ç©ºçš„ï¼‰
              if (currentCell === "ç‚Šäº‹") {
                // æª¢æŸ¥å¾Œé¢å…©æ ¼æ˜¯å¦ç‚ºç©º
                if (
                  cellIndex + 1 < row.length &&
                  (row[cellIndex + 1].trim() === "" ||
                    row[cellIndex + 1].trim() === "-")
                ) {
                  row[cellIndex + 1] = "ç‚Šäº‹";
                }
                if (
                  cellIndex + 2 < row.length &&
                  (row[cellIndex + 2].trim() === "" ||
                    row[cellIndex + 2].trim() === "-")
                ) {
                  row[cellIndex + 2] = "ç‚Šäº‹";
                }
              }
            }
            return cell;
          });
        });
      }

      /*******************************************************
       * è’å…‰æ•™æœƒç‰¹åŒ–å‡½æ•¸ï¼šè‡ªå‹•å¡«å…¥è¥¿å…ƒå¹´æœˆä»½
       *******************************************************/
      function jgtjcAutoFillYearMonth(data) {
        // å°‹æ‰¾ç¬¬ä¸€å€‹åŒ…å« "XXXå¹´XXæœˆ" æ ¼å¼çš„è³‡æ–™
        for (let rowIndex = 0; rowIndex < data.length; rowIndex++) {
          const row = data[rowIndex];
          for (let colIndex = 0; colIndex < row.length; colIndex++) {
            const cell = row[colIndex];
            if (cell && typeof cell === "string") {
              const match = cell.match(/(\d{3,4})å¹´(\d{1,2})æœˆ/);
              if (match) {
                let year = match[1];
                const month = match[2].padStart(2, "0"); // ç¢ºä¿æœˆä»½æ˜¯å…©ä½æ•¸

                // æ°‘åœ‹å¹´è½‰è¥¿å…ƒå¹´ï¼ˆæ°‘åœ‹å¹´ + 1911 = è¥¿å…ƒå¹´ï¼‰
                const westernYear = parseInt(year) + 1911;
                const yearMonth = westernYear.toString() + month;

                // è‡ªå‹•å¡«å…¥åˆ°æœˆä»½è¼¸å…¥æ¡†
                const monthInput = document.getElementById("monthInput");
                if (monthInput) {
                  monthInput.value = yearMonth;
                  console.log(
                    "æ°‘åœ‹å¹´è½‰è¥¿å…ƒå¹´ï¼š",
                    match[1] + "å¹´" + match[2] + "æœˆ â†’ " + yearMonth
                  );
                }
                return yearMonth; // è¿”å›æ‰¾åˆ°çš„å¹´æœˆ
              }
            }
          }
        }
        return null; // å¦‚æœæ²’æ‰¾åˆ°å°±è¿”å› null
      }

      /*******************************************************
       * è’å…‰æ•™æœƒç‰¹åŒ–å‡½æ•¸ï¼šè™•ç†æ¸…æƒå€åŸŸå’Œç’°å¢ƒæ¸…æ½”çš„é—œè¯
       *******************************************************/
      function jgtjcProcessCleaningArea(workSheet) {
        // å»ºç«‹æ—¥æœŸåˆ°æ¸…æƒå€åŸŸçš„æ˜ å°„
        const dateToCleaningArea = {};

        // ç¬¬ä¸€éï¼šæ”¶é›†æ‰€æœ‰æ¸…æƒå€åŸŸçš„è³‡è¨Š
        for (const personName in workSheet) {
          workSheet[personName].forEach((job) => {
            if (job.task === "æ¸…æƒå€åŸŸ") {
              const date = job.date;
              // æŠŠäººåç•¶ä½œå€åŸŸè³‡è¨Š
              if (!dateToCleaningArea[date]) {
                dateToCleaningArea[date] = [];
              }
              dateToCleaningArea[date].push(personName);
            }
          });
        }

        // ç¬¬äºŒéï¼šæ›´æ–°ç’°å¢ƒæ¸…æ½”çš„å·¥ä½œå…§å®¹
        for (const personName in workSheet) {
          workSheet[personName].forEach((job) => {
            if (job.task === "ç’°å¢ƒæ¸…æ½”") {
              const date = job.date;
              const areas = dateToCleaningArea[date];
              if (areas && areas.length > 0) {
                // å°‡å€åŸŸè³‡è¨Šåˆä½µåˆ°ç’°å¢ƒæ¸…æ½”ä¸­
                job.task = `ç’°å¢ƒæ¸…æ½”-å€åŸŸï¼š${areas.join("ã€")}`;
              }
            }
          });
        }

        console.log("è™•ç†æ¸…æƒå€åŸŸå¾Œçš„çµæœï¼š", workSheet);
        return workSheet;
      }

      /*******************************************************
       * 3. ä¾æ°´å¹³ç©ºç™½è¡Œã€å‚ç›´ç©ºç™½æ¬„åˆ‡å‰² CSV
       *******************************************************/
      function splitTablesByEmptyRowsAndColumns(csvData) {
        // 1) æ°´å¹³ç©ºç™½è¡Œ
        const blocks = [];
        let currentBlock = [];
        csvData.forEach((row) => {
          const isRowEmpty = row.every((cell) => cell.trim() === "");
          if (isRowEmpty) {
            if (currentBlock.length > 0) {
              blocks.push(currentBlock);
              currentBlock = [];
            }
          } else {
            currentBlock.push(row);
          }
        });
        if (currentBlock.length > 0) {
          blocks.push(currentBlock);
        }

        // 2) å‚ç›´ç©ºç™½æ¬„
        const tables = [];
        blocks.forEach((block) => {
          const maxColumns = block.reduce(
            (max, row) => Math.max(max, row.length),
            0
          );
          let boundary = -1;
          for (let col = 1; col < maxColumns - 1; col++) {
            let emptyCount = 0;
            block.forEach((row) => {
              if (!row[col] || row[col].trim() === "") {
                emptyCount++;
              }
            });
            if (emptyCount > block.length / 1) {
              boundary = col;
              break;
            }
          }
          if (boundary === -1) {
            tables.push(block);
          } else {
            const leftTable = block.map((row) => row.slice(0, boundary));
            const rightTable = block.map((row) => row.slice(boundary));
            tables.push(leftTable, rightTable);
          }
        });

        console.log("åˆ†å€å¾Œçš„çµæœï¼š", tables);
        return tables;
      }

      /*******************************************************
       * 4. ä¾ã€Œæ—¥æœŸ/æ˜ŸæœŸã€é—œéµå­—é€²ä¸€æ­¥åˆ†å‰²
       *******************************************************/
      function splitTablesByDateKeyword(tableBlocks) {
        const finalSubTables = [];

        function isDateHeader(row) {
          return row.some((cell) => {
            const txt = cell.trim();
            return txt.includes("æ—¥æœŸ") || txt.includes("æ˜ŸæœŸ");
          });
        }
        function isRowEmpty(row) {
          return row.every((cell) => cell.trim() === "");
        }
        function isValidDateOrWeek(row) {
          if (row.length === 0) return false;
          const text = row[0].trim();
          if (text === "") return true; // ç©ºå­—ä¸²
          if (!isNaN(text)) return true; // ç´”æ•¸å­—
          const firstChar = text.charAt(0);
          const validChars = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"];
          if (validChars.includes(firstChar)) return true;
          if (text === "æ˜ŸæœŸ" || text === "æ—¥æœŸ") return true;
          const withoutDash = text.replace("-", "");
          if (!isNaN(withoutDash)) return true;
          return false;
        }

        tableBlocks.forEach((block) => {
          if (block.every((row) => row[0].trim() === "")) {
            block.forEach((row) => row.shift());
          }
          let subTables = [];
          let currentSubTable = [];
          let emptyLineCount = 0;
          let inSubTable = false;

          block.forEach((row) => {
            const rowIsEmpty = isRowEmpty(row);
            emptyLineCount = rowIsEmpty ? emptyLineCount + 1 : 0;
            const hasDateHeader = isDateHeader(row);

            if (hasDateHeader) {
              if (inSubTable && currentSubTable.length > 0) {
                subTables.push(currentSubTable);
                currentSubTable = [];
              }
              inSubTable = true;
              currentSubTable.push(row);
            } else if (inSubTable && !rowIsEmpty) {
              currentSubTable.push(row);
            }

            if (emptyLineCount >= 2 && inSubTable) {
              subTables.push(currentSubTable);
              currentSubTable = [];
              inSubTable = false;
            }
            if (!isValidDateOrWeek(row) && inSubTable) {
              currentSubTable.pop();
              subTables.push(currentSubTable);
              currentSubTable = [];
              inSubTable = false;
            }
          });
          if (currentSubTable.length > 0) {
            subTables.push(currentSubTable);
          }
          if (subTables.length === 0) {
            subTables.push(block);
          }
          finalSubTables.push(subTables);
        });

        console.log("äºŒæ¬¡åˆ‡å‰²çµæœï¼š", finalSubTables);
        return finalSubTables;
      }

      /*******************************************************
       * 5. å¾ç¬¬ä¸€å€‹å­è¡¨æ ¼æŠ“å–ã€Œxxxxå¹´xxæœˆã€
       *******************************************************/
      function extractYearMonth(titleRow) {
        console.log("titleRow", titleRow);
        const match = titleRow[0].match(/(\d{4})å¹´(\d{1,2})æœˆ/);
        if (match) {
          return { year: match[1], month: match[2] };
        }
        return { year: "", month: "" };
      }

      /*******************************************************
       * 6. è£œå…¨ã€Œæ—¥æœŸæ¬„ä½ã€ã€Œå…­ä¸‹æ¬„ä½ã€ä¸¦ç§»é™¤æ›è¡Œç¬¦è™Ÿ
       *******************************************************/
      function fillDateAndSixDown(table) {
        // è‹¥ç¬¬äºŒè¡Œç¬¬ä¸€æ ¼ç‚ºç©º -> è¡¨é ­å…©è¡Œåˆä½µ
        if (table.length >= 2 && table[1][0].trim() === "") {
          const secondHeader = table[1];
          for (let col = 0; col < secondHeader.length; col++) {
            const cellVal = secondHeader[col].trim();
            if (cellVal !== "") {
              table[0][col] = table[0][col].trim()
                ? table[0][col].trim() + "/" + cellVal
                : cellVal;
            }
          }
          table.splice(1, 1);
        }

        // è£œå…¨æ¨™é ­
        if (table.length > 0) {
          for (let col = 1; col < table[0].length; col++) {
            if (!table[0][col] || table[0][col].trim() === "") {
              table[0][col] = table[0][col - 1];
            }
          }
        }

        // å¾ç¬¬äºŒåˆ—é–‹å§‹
        for (let i = 1; i < table.length; i++) {
          const row = table[i];
          const prevRow = table[i - 1];
          // æ—¥æœŸæ¬„ç©º -> ç”¨ä¸Šä¸€åˆ—æ—¥æœŸ
          if (
            (!row[0] || row[0].trim() === "") &&
            prevRow[0] &&
            !isNaN(prevRow[0].trim())
          ) {
            row[0] = prevRow[0];
          }
          // è‹¥ç¬¬äºŒæ¬„ç‚º "å…­ä¸‹"ï¼Œä¸”ç¬¬ä¸‰æ¬„ç©º -> ç”¨ä¸Šä¸€åˆ—ç¬¬ä¸‰æ¬„è£œ
          if (row[1] && row[1].trim() === "å…­ä¸‹") {
            if (!row[2] || row[2].trim() === "") {
              if (prevRow[2] && prevRow[2].trim() !== "") {
                row[2] = prevRow[2];
              }
            }
          }
        }

        // ç§»é™¤æ›è¡Œç¬¦è™Ÿ
        for (let i = 0; i < table.length; i++) {
          for (let j = 0; j < table[i].length; j++) {
            table[i][j] = table[i][j].replace(/\n\s*/g, "");
          }
        }

        // è‹¥ç¬¬ä¸€åˆ—ç¬¬äºŒæ¬„æ˜¯ "æœƒå¾Œå ±å‘Š"ï¼Œé‡åˆ°ç©ºå‰‡ç”¨ä¸Šä¸€åˆ—è£œ
        if (table[0][1].replace("\n", "") === "æœƒå¾Œå ±å‘Š") {
          for (let i = 1; i < table.length; i++) {
            if (!table[i][1] || table[i][1].trim() === "") {
              table[i][1] = table[i - 1][1] || "";
            }
          }
        }

        console.log("å¡«è£œä¸¦æ¸…ç†å¾Œçš„è¡¨æ ¼ï¼š", table);
        return table;
      }

      /*******************************************************
       * 7. è¨ˆç®—ç‰¹å®šæ—¥æœŸçš„æ˜ŸæœŸ & è¨ˆç®—æŸæ˜ŸæœŸå°æ‡‰ä¹‹æ‰€æœ‰æ—¥æœŸ
       *******************************************************/
      function getWeekdayFromDate(year, month, dateNum) {
        const dt = new Date(year, month - 1, dateNum);
        return dt.getDay(); // 0=æ—¥,1=ä¸€,...,6=å…­
      }
      function getDatesForWeekday(year, month, weekdayNum) {
        const dates = [];
        const daysInMonth = new Date(year, month, 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
          const dt = new Date(year, month - 1, d);
          if (dt.getDay() === weekdayNum) {
            dates.push(d);
          }
        }
        return dates;
      }

      /*******************************************************
       * 8. å°‡å¤šè¡¨æ ¼è½‰ç‚ºã€Œå·¥ä½œè¡¨ç‰©ä»¶ã€(ä»¥äººåç‚º key)
       *******************************************************/
      function tablesToWork(finalTables, { year, month }) {
        const workSheet = {};
        const validWeekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        const weekdayMapping = {
          æ—¥: 0,
          ä¸€: 1,
          äºŒ: 2,
          ä¸‰: 3,
          å››: 4,
          äº”: 5,
          å…­: 6,
        };

        finalTables.forEach((table) => {
          // æª¢æŸ¥ç¬¬ä¸€åˆ—ç¬¬ä¸€æ ¼ï¼Œåˆ¤æ–·æ¨¡å¼
          if (table[0][0] === "æ—¥æœŸ") {
            // æ—¥æœŸæ¨¡å¼
            let hasWeekday = false;
            if (table[0][1] === "æ˜ŸæœŸ") {
              hasWeekday = true;
            }
            const workStartIndex = hasWeekday ? 2 : 1;

            for (let i = 1; i < table.length; i++) {
              const dateVal = table[i][0];
              for (let j = workStartIndex; j < table[i].length; j++) {
                const cellVal = table[i][j].trim();
                if (cellVal === "" || cellVal === "-") continue;

                // å¤šäººåˆ†é…
                if (cellVal.includes("âˆ£") || cellVal.includes(" ")) {
                  // å…ˆæŒ‰ âˆ£ åˆ†å‰²ï¼Œå†æŒ‰ç©ºæ ¼åˆ†å‰²
                  let multiplePersons = [];
                  if (cellVal.includes("âˆ£")) {
                    multiplePersons = cellVal.split("âˆ£");
                  } else {
                    multiplePersons = cellVal.split(" ");
                  }

                  multiplePersons.forEach((personName) => {
                    personName = personName.trim().replace(/\s+/g, "");
                    if (!personName || personName === "") return;
                    if (!workSheet[personName]) workSheet[personName] = [];
                    workSheet[personName].push({
                      date: dateVal,
                      weekDay: hasWeekday
                        ? table[i][1]
                        : validWeekdays[
                            getWeekdayFromDate(year, month, dateVal)
                          ],
                      work: table[0][j],
                    });
                  });
                } else {
                  // å–®ä¸€è² è²¬äºº
                  const cleanName = cellVal.trim().replace(/\s+/g, "");
                  if (!workSheet[cleanName]) {
                    workSheet[cleanName] = [];
                  }
                  workSheet[cleanName].push({
                    date: dateVal,
                    weekDay: hasWeekday
                      ? table[i][1]
                      : validWeekdays[getWeekdayFromDate(year, month, dateVal)],
                    work: table[0][j],
                  });
                }
              }
            }
          } else if (table[0][0] === "æ˜ŸæœŸ") {
            // æ˜ŸæœŸæ¨¡å¼
            for (let i = 1; i < table.length; i++) {
              for (let j = 1; j < table[i].length; j++) {
                const person = table[i][j].trim().replace(/\s+/g, "");
                if (person === "" || person === "-") continue;
                const targetWeekday = table[i][0];
                if (!validWeekdays.includes(targetWeekday[0])) {
                  console.warn("åµæ¸¬åˆ°ç„¡æ•ˆæ˜ŸæœŸ:", targetWeekday);
                  continue;
                }
                const possibleDates = getDatesForWeekday(
                  year,
                  month,
                  weekdayMapping[targetWeekday[0]]
                );
                possibleDates.forEach((d) => {
                  if (!workSheet[person]) {
                    workSheet[person] = [];
                  }
                  workSheet[person].push({
                    date: d.toString(),
                    weekDay: targetWeekday,
                    work: table[0][j],
                  });
                });
              }
            }
          } else {
            console.error(
              "è¡¨æ ¼ç¬¬ä¸€åˆ—ç¬¬ä¸€æ ¼æ—¢ä¸æ˜¯ã€æ—¥æœŸã€ä¹Ÿä¸æ˜¯ã€æ˜ŸæœŸã€ï¼Œå¿½ç•¥è™•ç†ï¼š",
              table[0]
            );
          }
        });
        return workSheet;
      }

      /**
       * å°‡ workSheet ä¸­æ¯å€‹äººçš„å·¥ä½œé …ç›®ï¼Œ
       * å¾ { date, weekDay, work } è½‰ç‚º { date, timeSlot, task }ï¼Œ
       * ä¸¦è·³éä»»ä½•æœ‰ undefined æ¬„ä½çš„é …ç›®ã€‚
       *
       * @param {Object} workSheet - åŸå§‹çš„å·¥ä½œè¡¨ç‰©ä»¶ï¼Œä¾‹å¦‚ï¼š
       * {
       *   "ç‹å°æ˜": [
       *     { date: "12", weekDay: "ä¸‰", work: "æœƒå‰é ˜è©©" },
       *     { date: "12", weekDay: "ä¸‰", work: "ç¿»è­¯" },
       *     { date: undefined, weekDay: "ä¸‰", work: "å…¶ä»–" } // é€™ç­†æœƒè¢«è·³é
       *   ],
       *   "æå¤§è¯": [
       *     { date: "15", weekDay: "å…­ä¸‹", work: "å¸ç´" }
       *   ]
       * }
       * @returns {Object} - è½‰æ›å¾Œçš„å·¥ä½œè¡¨ç‰©ä»¶ï¼Œçµæ§‹ç‚ºï¼š
       * {
       *   "ç‹å°æ˜": [
       *     { date: "12", timeSlot: "ä¸‰", task: "æœƒå‰é ˜è©©" },
       *     { date: "12", timeSlot: "ä¸‰", task: "ç¿»è­¯" }
       *   ],
       *   "æå¤§è¯": [
       *     { date: "15", timeSlot: "å…­ä¸‹", task: "å¸ç´" }
       *   ]
       * }
       */
      function transformWorkSheet(workSheet) {
        const transformedSheet = {};
        for (const personName in workSheet) {
          // å»é™¤ personName ä¸­çš„æ‰€æœ‰æ–œç·š
          const cleanPersonName = personName.replace(/\//g, "");
          transformedSheet[cleanPersonName] = workSheet[personName].reduce(
            (acc, item) => {
              // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ¬„ä½ç‚º undefined
              if (
                item.date !== undefined &&
                item.weekDay !== undefined &&
                item.work !== undefined
              ) {
                acc.push({
                  date: item.date,
                  timeSlot: item.weekDay,
                  task: item.work,
                });
              }
              return acc;
            },
            []
          );
        }
        return transformedSheet;
      }

      /*******************************************************
       * å…¨åŸŸè®Šæ•¸ï¼šå„²å­˜ã€Œæœ€çµ‚çš„è½‰æ›å¾Œå·¥ä½œè¡¨ç‰©ä»¶ã€
       *******************************************************/
      let finalTransformedSheet = null;

      /*******************************************************
       * åˆå§‹åŒ–åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½ï¼šç”Ÿæˆå¹´æœˆä¸‹æ‹‰é¸å–®
       *******************************************************/
      function initializeImageUpload() {
        const select = document.getElementById("imageMonthSelect");
        const currentDate = new Date();

        // ç”Ÿæˆ -3 åˆ° +6 å€‹æœˆçš„é¸é …
        for (let i = -3; i <= 6; i++) {
          const targetDate = new Date(
            currentDate.getFullYear(),
            currentDate.getMonth() + i,
            1
          );
          const year = targetDate.getFullYear();
          const month = (targetDate.getMonth() + 1).toString().padStart(2, "0");
          const yearMonth = `${year}${month}`;

          const option = document.createElement("option");
          option.value = yearMonth;
          option.textContent = `${year}å¹´${month}æœˆ (${yearMonth})`;

          // å¦‚æœæ˜¯ç•¶å‰æœˆä»½ï¼Œè¨­ç‚ºé è¨­é¸é …
          if (i === 0) {
            option.selected = true;
          }

          select.appendChild(option);
        }
      }

      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        initializeImageUpload();
        initializeUploadTypeHandler();
      });

      /*******************************************************
       * åˆå§‹åŒ–ä¸Šå‚³é¡å‹è®Šæ›´è™•ç†
       *******************************************************/
      function initializeUploadTypeHandler() {
        const uploadTypeSelect = document.getElementById("uploadTypeSelect");
        const monthSelectContainer = document.getElementById(
          "monthSelectContainer"
        );

        // è¨­å®šè®Šæ›´äº‹ä»¶ç›£è½å™¨
        uploadTypeSelect.addEventListener("change", function () {
          const selectedType = this.value;

          if (selectedType === "schedule") {
            // é¸æ“‡å®‰æ’è¡¨æ™‚é¡¯ç¤ºå¹´æœˆé¸é …
            monthSelectContainer.style.display = "block";
          } else {
            // é¸æ“‡ç­ç´šæ™‚éš±è—å¹´æœˆé¸é …
            monthSelectContainer.style.display = "none";
          }
        });

        // åˆå§‹åŒ–æ™‚æ ¹æ“šé è¨­å€¼è¨­å®šé¡¯ç¤ºç‹€æ…‹
        const initialType = uploadTypeSelect.value;
        if (initialType === "schedule") {
          monthSelectContainer.style.display = "block";
        } else {
          monthSelectContainer.style.display = "none";
        }
      }

      /*******************************************************
       * äº‹ä»¶ï¼šè§£æç¶²å€ â†’ å¡«å…¥ sheetId/gid
       *******************************************************/
      document
        .getElementById("parseButton")
        .addEventListener("click", function () {
          const url = document.getElementById("urlInput").value.trim();
          if (!url) {
            alert("è«‹è²¼ä¸Šæœ‰æ•ˆçš„ Google è©¦ç®—è¡¨ç¶²å€æˆ– Sheet IDï¼");
            return;
          }
          const { sheetId, gid } = parseSpreadsheetUrl(url);
          if (!sheetId) {
            alert("ç„¡æ³•è§£æå‡º sheetIdï¼Œè«‹ç¢ºèªç¶²å€æ˜¯å¦æ­£ç¢ºã€‚");
            return;
          }
          document.getElementById("sheetIdInput").value = sheetId;
          document.getElementById("gidInput").value = gid;
        });

      /*******************************************************
       * äº‹ä»¶ï¼šæŠ“å– CSV â†’ Papa Parse â†’ åˆ‡å‰² â†’ è£œå…¨ â†’ è½‰æ›
       *******************************************************/
      document
        .getElementById("fetchButton")
        .addEventListener("click", function () {
          const sheetId = document.getElementById("sheetIdInput").value.trim();
          const gid = document.getElementById("gidInput").value.trim();
          const output = document.getElementById("output");
          output.textContent = "è§£æä¸­...";

          if (!sheetId) {
            alert("è«‹å…ˆå¡«å…¥ sheetIdï¼");
            return;
          }
          const finalGid = gid || "0";
          const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&id=${sheetId}&gid=${finalGid}`;

          fetch(csvUrl)
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.text();
            })
            .then((csvText) => {
              // 1) Papa Parse
              const parsedCsv = Papa.parse(csvText);

              // 2) è’å…‰æ•™æœƒç‰¹åŒ–ï¼šç«‹å³è™•ç†æ¥å¾…äººå“¡è‡ªå‹•è£œå…¨ï¼ˆè³‡æ–™ä¸€é€²ä¾†å°±åŸ·è¡Œï¼‰
              const processedData = jgtjcProcessReceptionist(parsedCsv.data);
              console.log("ç«‹å³è™•ç†æ¥å¾…äººå“¡å¾Œçš„åŸå§‹è³‡æ–™ï¼š", processedData);

              // 3) è’å…‰æ•™æœƒç‰¹åŒ–ï¼šè‡ªå‹•å¡«å…¥è¥¿å…ƒå¹´æœˆä»½
              jgtjcAutoFillYearMonth(parsedCsv.data);

              // 3) æ°´å¹³ç©ºç™½è¡Œ + å‚ç›´ç©ºç™½æ¬„
              const tableBlocks =
                splitTablesByEmptyRowsAndColumns(processedData);

              // 4) ä¾æ—¥æœŸ/æ˜ŸæœŸé—œéµå­—å†åˆ‡å‰²
              const dateSubTables = splitTablesByDateKeyword(tableBlocks);

              // 5) æ”¤å¹³æˆå–®ä¸€é™£åˆ—
              const flatTables = [];
              dateSubTables.forEach((blocks) => {
                blocks.forEach((subTable) => {
                  flatTables.push(subTable);
                });
              });

              // ç§»é™¤æ‰€æœ‰ç©ºçš„ç›´è¡Œ
              function removeEmptyColumns(table) {
                if (!table.length) return table;
                const colCount = table[0].length;
                // æ‰¾å‡ºå“ªäº›æ¬„ä½æ˜¯å…¨ç©º
                const emptyCols = [];
                for (let col = 0; col < colCount; col++) {
                  let allEmpty = true;
                  for (let row = 0; row < table.length; row++) {
                    if (table[row][col] && table[row][col].trim() !== "") {
                      allEmpty = false;
                      break;
                    }
                  }
                  if (allEmpty) emptyCols.push(col);
                }
                // å»ºç«‹æ–°çš„ tableï¼Œç§»é™¤ç©ºæ¬„
                return table.map((row) =>
                  row.filter((_, idx) => !emptyCols.includes(idx))
                );
              }

              const validFlatTables = flatTables
                .map(removeEmptyColumns)
                .filter((table) =>
                  table.some((row) => row.some((cell) => cell !== ""))
                );

              console.log("ç§»é™¤æ‰€æœ‰ç©ºçš„ç›´è¡Œå¾Œçš„è¡¨æ ¼ï¼š", validFlatTables);

              // 6) å¾ç¬¬ä¸€å€‹å­è¡¨æ ¼æŠ“å– yearMonth (è‹¥å¯å–å¾—)
              const yearMonth = extractYearMonth(validFlatTables[0][0]);
              console.log("yearMonth", yearMonth);

              // 7) ç¯©é¸å‡ºç¬¬ä¸€åˆ—ç¬¬ä¸€æ ¼ç‚ºã€Œæ—¥æœŸã€æˆ–ã€Œæ˜ŸæœŸã€çš„è¡¨æ ¼
              const validTables = validFlatTables.filter((table) => {
                if (table[0].length === 0) return false;
                const firstCell = table[0][0].trim();
                return firstCell === "æ—¥æœŸ" || firstCell === "æ˜ŸæœŸ";
              });
              console.log("æœ‰æ•ˆå®‰æ’è¡¨ï¼š", validTables);

              // æœ‰æ•ˆå®‰æ’è¡¨æ‡‰ç‚º2ä»½ å¦‚æœæ²’æœ‰ è¦æç¤º
              if (validTables.length !== 2) {
                alert("æœ‰æ•ˆå®‰æ’è¡¨æ‡‰ç‚º2ä»½ ç›®å‰æ•¸é‡æœ‰èª¤ è«‹é€²è¡Œé¡å¤–ç¢ºèª");
              }

              // 8) è£œå…¨æ¬„ä½
              const finalTables = validTables.map((table) =>
                fillDateAndSixDown(table)
              );
              console.log("æœ€çµ‚è™•ç†å¾Œçš„è¡¨æ ¼ï¼š", finalTables);

              // 8) è½‰æ›æˆ workSheet
              const workSheet = tablesToWork(finalTables, yearMonth);
              console.log("åŸå§‹å·¥ä½œè¡¨ç‰©ä»¶ï¼š", workSheet);

              // 9) é€²ä¸€æ­¥è½‰æˆ { date, timeSlot, task }
              finalTransformedSheet = transformWorkSheet(workSheet);
              console.log("è½‰æ›å¾Œçš„å·¥ä½œè¡¨ç‰©ä»¶ï¼š", finalTransformedSheet);

              // 10) è’å…‰æ•™æœƒç‰¹åŒ–ï¼šè™•ç†æ¸…æƒå€åŸŸå’Œç’°å¢ƒæ¸…æ½”çš„é—œè¯
              finalTransformedSheet = jgtjcProcessCleaningArea(
                finalTransformedSheet
              );

              // é¡¯ç¤ºæ¯å€‹ä½¿ç”¨è€…çš„å·¥ä½œæƒ…å½¢
              const userJobsDiv = document.getElementById("userJobs");
              userJobsDiv.innerHTML = ""; // æ¸…ç©º
              for (const [user, jobs] of Object.entries(
                finalTransformedSheet
              )) {
                const card = document.createElement("div");
                card.className = "user-card";
                const title = document.createElement("h4");
                title.textContent = user;
                card.appendChild(title);

                if (jobs.length === 0) {
                  const empty = document.createElement("div");
                  empty.textContent = "ï¼ˆæœ¬æœˆç„¡å·¥ä½œï¼‰";
                  card.appendChild(empty);
                } else {
                  const ul = document.createElement("ul");
                  ul.className = "user-job-list";
                  jobs.forEach((job) => {
                    const li = document.createElement("li");
                    li.textContent = `ğŸ“… ${job.date}ï½œ${job.timeSlot}ï½œ${job.task}`;
                    ul.appendChild(li);
                  });
                  card.appendChild(ul);
                }
                userJobsDiv.appendChild(card);
              }

              // åœ¨ç•«é¢ä¸Šé¡¯ç¤º
              output.textContent = JSON.stringify(finalTables, null, 2);
            })
            .catch((error) => {
              console.error(error);
              output.textContent = "æŠ“å–æˆ–è§£æè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message;
            });
        });

      /*******************************************************
       * äº‹ä»¶ï¼šå°‡ finalTransformedSheet ä¸Šå‚³è‡³ Firebase
       *******************************************************/
      document
        .getElementById("uploadBtn")
        .addEventListener("click", function () {
          const month = document.getElementById("monthInput").value.trim();
          if (!month || !/^\d{6}$/.test(month)) {
            alert("è«‹è¼¸å…¥æ­£ç¢ºæ ¼å¼çš„æœˆä»½ (yyyymm)");
            return;
          }
          if (!finalTransformedSheet) {
            alert("å°šæœªç”Ÿæˆå·¥ä½œè¡¨è³‡æ–™ï¼Œè«‹å…ˆã€æŠ“å–è³‡æ–™ä¸¦è§£æã€ï¼");
            return;
          }

          const path = `line/schedule/jgtjc/${month}`;
          database.ref(path).set(finalTransformedSheet, function (error) {
            if (error) {
              alert("ä¸Šå‚³å¤±æ•—ï¼š" + error);
            } else {
              alert("æˆåŠŸä¸Šå‚³å·¥ä½œè¡¨è³‡æ–™è‡³ Firebaseï¼");
            }
          });
        });

      /*******************************************************
       * äº‹ä»¶ï¼šæª¢è¦–åœ–ç‰‡é è¦½
       *******************************************************/
      document
        .getElementById("previewImageBtn")
        .addEventListener("click", function () {
          const imageUrl = document
            .getElementById("imageUrlInput")
            .value.trim();

          if (!imageUrl) {
            alert("è«‹å…ˆè¼¸å…¥åœ–ç‰‡ç¶²å€ï¼");
            return;
          }

          // ç°¡å–®çš„ç¶²å€æ ¼å¼é©—è­‰
          try {
            new URL(imageUrl);
          } catch (e) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¶²å€æ ¼å¼ï¼");
            return;
          }

          const previewContainer = document.getElementById(
            "imagePreviewContainer"
          );

          // ç›´æ¥é¡¯ç¤ºåœ–ç‰‡ï¼Œä¸é€²è¡Œé å…ˆè¼‰å…¥æ¸¬è©¦
          previewContainer.style.display = "block";
          previewContainer.innerHTML = `
            <div style="border: 1px solid #2196f3; padding: 10px; border-radius: 4px; background: #e3f2fd;">
              <img 
                src="${imageUrl}" 
                style="max-width: 100%; max-height: 200px; border-radius: 4px; display: block; margin: 0 auto;" 
                onload="this.parentElement.style.borderColor='#4caf50'; this.parentElement.style.backgroundColor='#e8f5e8'; this.nextElementSibling.innerHTML='âœ… åœ–ç‰‡è¼‰å…¥æˆåŠŸ<br><small style=\\'color:#666;\\'>ç¶²å€ï¼š${imageUrl}</small>'; this.nextElementSibling.style.color='#2e7d32';"
                onerror="this.style.display='none'; this.parentElement.style.borderColor='#ff9800'; this.parentElement.style.backgroundColor='#fff3e0'; this.nextElementSibling.innerHTML='âš ï¸ ç€è¦½å™¨é è¦½å¤±æ•—<br><small style=\\'font-size:0.8em;\\'>å¸¸è¦‹æ–¼ imgur ç­‰æœå‹™çš„å®‰å…¨é™åˆ¶<br><strong>ç¶²å€æœ¬èº«å¯èƒ½æ˜¯æ­£ç¢ºçš„ï¼Œå»ºè­°ç›´æ¥ä¸Šå‚³ï¼</strong><br><br>ç¶²å€ï¼š${imageUrl}</small>'; this.nextElementSibling.style.color='#ef6c00';"
              />
              <div style="margin-top: 5px; font-size: 0.9em; color: #1976d2; text-align: center;">
                ğŸ”„ è¼‰å…¥åœ–ç‰‡ä¸­...
              </div>
            </div>
          `;
        });

      /*******************************************************
       * äº‹ä»¶ï¼šå°‡åœ–ç‰‡ç¶²å€ä¸Šå‚³è‡³ Firebase
       *******************************************************/
      document
        .getElementById("uploadImageBtn")
        .addEventListener("click", function () {
          const imageUrl = document
            .getElementById("imageUrlInput")
            .value.trim();
          const selectedMonth =
            document.getElementById("imageMonthSelect").value;
          const uploadType = document.getElementById("uploadTypeSelect").value;

          if (!imageUrl) {
            alert("è«‹è¼¸å…¥åœ–ç‰‡ç¶²å€ï¼");
            return;
          }

          // ç°¡å–®çš„ç¶²å€æ ¼å¼é©—è­‰
          try {
            new URL(imageUrl);
          } catch (e) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¶²å€æ ¼å¼ï¼");
            return;
          }

          if (!uploadType) {
            alert("è«‹é¸æ“‡ä¸Šå‚³é¡å‹ï¼");
            return;
          }

          // å¦‚æœæ˜¯å®‰æ’è¡¨ä½†æ²’é¸æ“‡å¹´æœˆï¼Œæç¤ºéŒ¯èª¤
          if (uploadType === "schedule" && !selectedMonth) {
            alert("è«‹é¸æ“‡å¹´æœˆï¼");
            return;
          }

          // æ ¹æ“šä¸Šå‚³é¡å‹æ±ºå®šè·¯å¾‘
          let path;
          if (uploadType === "schedule") {
            path = `line/schedule/jgtjc/schedule_image/${selectedMonth}`;
          } else {
            path = `line/schedule/jgtjc/class/${uploadType}`;
          }

          database.ref(path).set(imageUrl, function (error) {
            if (error) {
              alert("ä¸Šå‚³å¤±æ•—ï¼š" + error);
            } else {
              alert(
                `æˆåŠŸä¸Šå‚³åœ–ç‰‡ç¶²å€è‡³ Firebaseï¼\né¡å‹ï¼š${
                  uploadType === "schedule" ? "å®‰æ’è¡¨" : uploadType
                }\nè·¯å¾‘ï¼š${path}\nç¶²å€ï¼š${imageUrl}`
              );
              // æ¸…ç©ºè¼¸å…¥æ¡†å’Œé è¦½
              document.getElementById("imageUrlInput").value = "";
              document.getElementById("imagePreviewContainer").style.display =
                "none";
            }
          });
        });
    </script>
  </body>
</html>
